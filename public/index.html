<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luxon TMS</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    /* Global */
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:
        radial-gradient(130% 130% at 0% 0%, #0b1120 0%, #020617 45%, #020617 100%);
      min-height:100vh;
      color:#e5e7eb;
      padding:20px;
    }
    .container{max-width:1400px;margin:0 auto}

    /* --- LOGIN SCREEN STYLES (Themed) --- */
    #loginOverlay {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: radial-gradient(130% 130% at 0% 0%, #0b1120 0%, #020617 45%, #020617 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .login-box {
      background: #020617;
      padding: 40px 50px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      width: 100%;
      max-width: 420px;
      text-align: center;
    }
    .login-title {
      font-size: 2.5rem;
      font-weight: 800;
      text-transform: uppercase;
      background: linear-gradient(90deg,#22c55e,#38bdf8,#a855f7);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 10px;
      letter-spacing: 0.05em;
    }
    .login-subtitle {
      color: #9ca3af;
      font-size: 1rem;
      margin-bottom: 30px;
      font-weight: 500;
      letter-spacing: 0.02em;
    }
    .login-input {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 1rem;
      margin-bottom: 20px;
      text-align: center;
      outline: none;
      transition: border-color 0.2s;
    }
    .login-input:focus {
      border-color: #2563eb;
    }
    .login-btn {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: none;
      background: #2563eb;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.1s, background 0.2s;
      box-shadow: 0 10px 25px rgba(37,99,235,0.5);
    }
    .login-btn:hover { background: #1d4ed8; }
    .login-btn:active { transform: translateY(1px); }
    .error-msg {
      color: #ef4444;
      font-size: 0.9rem;
      margin-top: 15px;
      display: none;
    }

    /* --- HIDE MAIN APP INITIALLY --- */
    #mainApp { display: none; }

    /* Header */
    .header{
      background:linear-gradient(135deg,#020617 0%,#020617 45%,#0b1120 100%);
      padding:24px 28px;
      border-radius:18px;
      margin-bottom:18px;
      box-shadow:0 18px 40px rgba(0,0,0,0.55);
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      border:1px solid rgba(148,163,184,0.35);
    }
    .header h1{
      font-size:2.7rem;
      letter-spacing:0.05em;
      font-weight:800;
      text-transform:uppercase;
      background:linear-gradient(90deg,#22c55e,#38bdf8,#a855f7);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .header-tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 16px;
      border-radius:999px;
      font-size:.8rem;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      background:rgba(15,118,110,0.12);
      border:1px solid rgba(74,222,128,0.4);
      color:#bbf7d0;
    }
    .header-tag-dot{
      width:8px;height:8px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 4px rgba(34,197,94,0.4);
    }

    /* Top bar (Revenue Year) */
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:flex-end;
      margin:10px 0 18px;
    }
    .topbar label{
      font-weight:700;
      color:#f9fafb;
      font-size:.9rem;
    }
    select.year{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      color:#e5e7eb;
      font-weight:500;
      box-shadow:0 6px 18px rgba(0,0,0,0.55);
    }

    /* Stat cards */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:16px;
      margin-bottom:22px;
    }
    .stat-card{
      background:#020617;
      padding:20px;
      border-radius:16px;
      text-align:center;
      box-shadow:0 12px 30px rgba(0,0,0,0.6);
      position:relative;
      border:1px solid #1f2937;
      color:#e5e7eb;
    }
    .stat-card.clickable{cursor:pointer}
    .stat-value{
      font-size:2rem;
      font-weight:bold;
      color:#60a5fa;
      margin-bottom:6px;
    }
    .stat-label{
      color:#9ca3af;
      font-size:.9rem;
      font-weight:500;
    }

    /* Tabs */
    .tabs{
      display:flex;
      background:rgba(15,23,42,0.98);
      border-radius:999px;
      margin-bottom:16px;
      overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,0.6);
      flex-wrap:wrap;
      border:1px solid #1f2937;
    }
    .tab{
      flex:1;
      padding:15px 18px;
      background:transparent;
      border:none;
      cursor:pointer;
      font-size:.95rem;
      font-weight:600;
      transition:all .18s;
      min-width:160px;
      color:#e5e7eb;
    }
    .tab:hover{
      background:rgba(30,64,175,0.6);
    }
    .tab.active{
      background:#2563eb;
      color:#fff;
    }

    /* Panels ‚Äì unified dark background (Analytics style) */
    .tab-content{
      display:none;
      background:rgba(15,23,42,0.98);
      padding:22px;
      border-radius:18px;
      box-shadow:0 18px 40px rgba(0,0,0,0.65);
      border:1px solid #1f2937;
      color:#e5e7eb;
    }
    .tab-content.active{display:block}

    /* Forms / controls */
    .form-grid{
      display:grid;
      grid-template-columns:repeat(12,minmax(0,1fr));
      gap:14px;
      margin-bottom:20px;
    }
    .form-group{display:flex;flex-direction:column}
    .form-group>*{width:100%}
    label{
      margin-bottom:8px;
      font-weight:700;
      color:#e5e7eb;
      font-size:.9rem;
    }
    input,select,textarea{
      padding:12px;
      border:1px solid #1f2937;
      border-radius:8px;
      font-size:1rem;
      background:#020617;
      color:#e5e7eb;
    }
    input::placeholder,textarea::placeholder{color:#6b7280}

    /* Buttons */
    .btn{
      background:#2563eb;
      color:#fff;
      border:none;
      padding:12px 18px;
      border-radius:10px;
      cursor:pointer;
      font-size:.95rem;
      font-weight:700;
      transition:transform .06s ease,background .12s ease;
      box-shadow:0 10px 25px rgba(37,99,235,0.5);
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{background:#1d4ed8}
    .btn-ghost{
      background:#020617;
      color:#e5e7eb;
      border:1px solid #374151;
      box-shadow:none;
    }
    .btn-danger{
      background:#dc2626;
      box-shadow:0 10px 25px rgba(220,38,38,0.4);
    }
    .btn-danger:hover{background:#b91c1c}
    /* AI Button Style */
    .btn-purple{
      background: #8b5cf6;
      color: #fff;
      box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
    }
    .btn-purple:hover{
      background: #7c3aed;
    }

    .csv-input{
      width:100%;
      height:80px;
      padding:15px;
      border:1px solid #1f2937;
      border-radius:8px;
      font-family:monospace;
      font-size:.9rem;
      background:#020617;
      color:#e5e7eb;
    }

    /* Tables ‚Äì dark style */
    table{
      width:100%;
      border-collapse:collapse;
      background:#020617;
      border-radius:12px;
      overflow:hidden;
      margin-top:12px;
      color:#e5e7eb;
      box-shadow:0 12px 30px rgba(0,0,0,0.6);
      border:1px solid #1f2937;
    }
    th,td{
      padding:12px;
      text-align:left;
      border-bottom:1px solid #111827;
      font-size:.9rem;
    }
    th{
      background:#020617;
      font-weight:800;
      color:#e5e7eb;
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    tbody tr:nth-child(odd){background:#030712;}
    tbody tr:nth-child(even){background:#020617;}

    .company-header{
      background:#020617 !important;
      font-weight:900;
    }
    .company-header td{
      border-top:2px solid #1f2937;
    }
    .company-name{font-weight:900}

    /* Status / revenue text */
    .revenue-positive{color:#4ade80;font-weight:bold}
    .revenue-negative{color:#fb923c;font-weight:bold}
    .status-active{color:#4ade80;font-weight:bold}
    .status-completed{color:#9ca3af;font-weight:bold}
    .status-booked{color:#60a5fa;font-weight:bold}

    a.mail{color:#60a5fa;text-decoration:none}
    a.mail:hover{text-decoration:underline}

    .subtle{color:#9ca3af;font-size:.95rem}

    .lane-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
      height:100%;
    }
    .lane-actions .btn{height:48px}

    .load-filters{
      display:flex;
      gap:8px;
      align-items:center;
      margin:10px 0 0;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #374151;
      cursor:pointer;
      font-weight:600;
      color:#e5e7eb;
      background:#020617;
      font-size:.8rem;
    }
    .pill.active{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
    }
    .modal{
      width:min(960px,95vw);
      max-height:90vh;
      overflow:auto;
      background:#020617;
      border-radius:14px;
      box-shadow:0 24px 70px rgba(0,0,0,.85);
      padding:22px;
      border:1px solid #1f2937;
      color:#e5e7eb;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .modal-title{
      font-size:1.3rem;
      font-weight:800;
      color:#e5e7eb;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:10px;
    }

    .field{margin:6px 0}
    .label{font-weight:700;color:#e5e7eb;margin-right:8px}

    .controls-row{
      grid-column:span 12;
      display:grid;
      grid-template-columns:repeat(12,minmax(0,1fr));
      gap:14px;
      align-items:end;
    }
    .run-actions{
      grid-column:span 3;
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    .nodata{margin:10px 0;color:#9ca3af;font-style:italic}
    .inline-row{
      display:flex;
      gap:10px;
      align-items:center;
      margin:10px 0 0;
    }

    /* Collapsible sections */
    .collapse{
      border:1px dashed #334155;
      background:#020617;
      border-radius:14px;
      margin-bottom:16px;
      overflow:hidden;
    }
    .collapse-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 16px;
      cursor:pointer;
      user-select:none;
      color:#e5e7eb;
    }
    .collapse-title{
      font-weight:800;
      color:#e5e7eb;
    }
    .collapse-body{
      max-height:0;
      overflow:hidden;
      transition:max-height .25s ease, padding .25s ease;
    }
    .collapse.open .collapse-body{padding:16px}
    .chev{transition:transform .25s ease}
    .open .chev{transform:rotate(180deg)}

    /* Sortable headers */
    .sortable{cursor:pointer;user-select:none}
    .sort-caret{margin-left:6px;font-weight:800;color:#60a5fa}

    /* Toast */
    .success-message{
      background:rgba(22,163,74,0.16);
      color:#bbf7d0;
      padding:15px 18px;
      border-radius:8px;
      font-weight:700;
      position:fixed;
      top:20px;
      right:20px;
      z-index:3000;
      border:1px solid rgba(34,197,94,0.5);
      box-shadow:0 16px 40px rgba(0,0,0,0.7);
    }

    /* AI Drag Drop Styles */
    .drop-zone {
      width: 100%;
      height: 200px;
      border: 2px dashed #4b5563;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #0f172a;
      transition: all 0.2s ease;
      position: relative;
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.1);
    }
    .drop-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: #9ca3af;
      margin-top: 10px;
    }
    .drop-subtext {
      font-size: 0.85rem;
      color: #6b7280;
    }
    .spinner {
      display: none;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(139, 92, 246, 0.3);
      border-radius: 50%;
      border-top-color: #8b5cf6;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 15px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .processing .spinner { display: block; }
    .processing .drop-icon { display: none; }
    .file-input { display: none; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <div id="loginOverlay">
    <div class="login-box">
      <div class="login-title">LUXON TMS</div>
      <div class="login-subtitle">AI-Powered Load Management</div>
      <input type="password" id="loginPass" class="login-input" placeholder="Enter Password" onkeypress="if(event.key==='Enter') doLogin()" autofocus />
      <button class="login-btn" onclick="doLogin()">Sign In</button>
      <div id="loginError" class="error-msg">Please enter a password</div>
    </div>
  </div>

  <div class="container" id="mainApp">
    <div class="header">
      <h1>Luxon TMS</h1>
      <div class="header-tag">
        <span class="header-tag-dot"></span>
        <span>REAL-TIME INSIGHTS FOR CARRIERS</span>
      </div>
    </div>

    <div class="topbar">
      <label for="yearSelect">Revenue Year:</label>
      <select id="yearSelect" class="year"></select>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalBrokers">0</div>
        <div class="stat-label">Broker Partners</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalLanes">0</div>
        <div class="stat-label">Historical Lanes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgRPM">$0.00</div>
        <div class="stat-label">Average RPM</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="completedLoads">0</div>
        <div class="stat-label">Completed Loads</div>
      </div>
      <div class="stat-card clickable" id="activeLoadsCard">
        <div class="stat-value" id="activeLoads">0</div>
        <div class="stat-label">Active Loads</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalRevenue">$0.00</div>
        <div class="stat-label">Total Revenue</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('loads', event)">Load Management</button>
      <button class="tab" onclick="showTab('brokers', event)">Broker Database</button>
      <button class="tab" onclick="showTab('lanes', event)">Lane Intelligence</button>
      <button class="tab" onclick="showTab('analytics', event)">Analytics</button>
      <button class="tab" onclick="showTab('directory', event)">Shippers & Receivers</button>
    </div>

    <div id="loads" class="tab-content active">
      <div id="addCollapse" class="collapse">
        <div class="collapse-header" onclick="toggleCollapse('addCollapse')">
          <div class="collapse-title">‚ûï Add New Load</div>
          <div class="chev">‚ñæ</div>
        </div>
        <div class="collapse-body">
          <div class="form-grid" style="margin-top:6px;">
            <div class="form-group" style="grid-column:span 2;"><label for="newId">Load ID</label><input id="newId" placeholder="12345"/></div>
            <div class="form-group" style="grid-column:span 2;"><label for="newPick">Pickup Date</label><input id="newPick" type="date"/></div>
            <div class="form-group" style="grid-column:span 2;"><label for="newDel">Delivery Date</label><input id="newDel" type="date"/></div>
            <div class="form-group" style="grid-column:span 3;"><label for="newBroker">Broker Company</label><input id="newBroker" placeholder="Acme Logistics"/></div>
            <div class="form-group" style="grid-column:span 3;"><label for="newContact">Contact Name</label><input id="newContact" placeholder="Alex Smith"/></div>

            <div class="form-group" style="grid-column:span 2;"><label for="newPhone">Phone</label><input id="newPhone" placeholder="555-0100"/></div>
            <div class="form-group" style="grid-column:span 1;"><label for="newExt">Ext</label><input id="newExt" placeholder=""/></div>
            <div class="form-group" style="grid-column:span 3;"><label for="newEmail">Email</label><input id="newEmail" placeholder="dispatch@example.com"/></div>

            <div class="form-group" style="grid-column:span 3;"><label for="newOrigin">Origin</label><input id="newOrigin" placeholder="Springfield IL"/></div>
            <div class="form-group" style="grid-column:span 3;"><label for="newDest">Destination</label><input id="newDest" placeholder="Riverton MO"/></div>
            <div class="form-group" style="grid-column:span 1;"><label for="newEquip">Equip</label><input id="newEquip" placeholder="R"/></div>
            <div class="form-group" style="grid-column:span 2;"><label for="newMiles">Miles</label><input id="newMiles" type="number" placeholder="500"/></div>
            <div class="form-group" style="grid-column:span 2;"><label for="newPosted">Posted Rate</label><input id="newPosted" type="number" step="0.01" placeholder="1200"/></div>
            <div class="form-group" style="grid-column:span 2;"><label for="newBooked">Booked Rate</label><input id="newBooked" type="number" step="0.01" placeholder="1300"/></div>

            <div class="form-group" style="grid-column:span 3;"><label for="newShipper">Shipper</label><input id="newShipper" placeholder="ABC Warehouse"/></div>
            <div class="form-group" style="grid-column:span 3;"><label for="newReceiver">Receiver</label><input id="newReceiver" placeholder="XYZ Distribution"/></div>

            <div class="form-group" style="grid-column:span 12;display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn" onclick="addNewLoad()">Save Load</button>
              <span id="newStatusHint" class="subtle"></span>
            </div>
          </div>
        </div>
      </div>

      <div id="importCollapse" class="collapse">
        <div class="collapse-header" onclick="toggleCollapse('importCollapse')">
          <div class="collapse-title">üìÅ Import / Backup / Cloud</div>
          <div class="chev">‚ñæ</div>
        </div>
        <div class="collapse-body">
          <p class="subtle"><strong>CSV Format:</strong> Load ID, Pickup Date, Delivery Date, Broker Company, Contact Name, Phone, Extension, Email, Origin, Destination, Equipment, Miles, Posted Rate, Booked Rate, Shipper, Receiver</p>
          <textarea id="loadCsvInput" class="csv-input" placeholder="12345,6/11/2025,6/12/2025,Acme Logistics,Alex Smith,555-0100,,dispatch@example.com,Springfield IL,Riverton MO,R,500,1200,1300,ABC Warehouse,XYZ Distribution"></textarea>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:14px;">
            <button class="btn btn-purple" onclick="openAiImport()">ü§ñ AI Import (PDF)</button>
            <button class="btn" onclick="importLoads()">üì• Import Loads</button>
            <button class="btn btn-ghost" onclick="exportData()">üíæ Export Backup (CSV)</button>
            <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            <button class="btn" onclick="syncToCloud()">‚òÅÔ∏è Sync to Cloud (Upsert)</button>
            <button class="btn" onclick="restoreFromCloud()">üîÑ Restore from Cloud</button>
          </div>
          <div class="subtle" style="margin-top:6px;">Sync uses <em>upsert</em> (no deletes). Restore merges cloud rows into local.</div>
        </div>
      </div>

      <div class="load-filters">
        <span class="subtle" style="font-weight:700;">Show:</span>
        <button class="pill active" id="filterAll" onclick="setStatusFilter('')">All</button>
        <button class="pill" id="filterBooked" onclick="setStatusFilter('Booked')">Booked</button>
        <button class="pill" id="filterActive" onclick="setStatusFilter('Active')">Active</button>
        <button class="pill" id="filterCompleted" onclick="setStatusFilter('Completed')">Completed</button>
      </div>

      <table id="loadsTable">
        <thead>
          <tr>
            <th>Load ID</th><th>Pickup Date</th><th>Delivery Date</th><th>Broker</th>
            <th>Lane</th><th>Equipment</th><th>Rate</th><th>Miles</th><th>RPM</th><th>Spread</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="brokers" class="tab-content">
      <h2>üìä Broker Partners</h2>

      <div class="inline-row">
        <div class="form-group" style="flex:1">
          <label for="brokerSearchInput">Search Broker (Company)</label>
          <input id="brokerSearchInput" placeholder="e.g., Allen Lund"/>
        </div>
        <button class="btn" onclick="applyBrokerSearch()">Search</button>
        <button class="btn btn-danger" onclick="clearBrokerSearch()">Clear</button>
      </div>

      <table id="brokersTable" style="margin-top:10px">
        <thead>
          <tr>
            <th>Company</th><th>Contact</th><th>Phone</th><th>Email</th>
            <th>Total Loads</th><th>Total Revenue</th><th>Last Load</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="lanes" class="tab-content">
      <h2>üìà Historical Lanes</h2>
      <div class="form-grid" style="margin-top:10px;">
        <div class="form-group" style="grid-column:span 4;"><label for="fromInput">From</label><input id="fromInput" placeholder="City, ST or ST"/></div>
        <div class="form-group" style="grid-column:span 4;"><label for="toInput">To</label><input id="toInput" placeholder="City, ST or ST (blank for open)"/></div>
        <div class="form-group" style="grid-column:span 2;"><label for="equipFilter">Equipment</label>
          <select id="equipFilter"><option value="">All</option><option>R</option><option>V</option><option>F</option><option>VR</option></select>
        </div>
        <div class="form-group" style="grid-column:span 2;">
          <div class="lane-actions">
            <button class="btn" onclick="applyLaneFilter()">Search</button>
            <button class="btn btn-danger" onclick="resetLaneFilter()">Clear</button>
          </div>
        </div>
      </div>

      <table id="lanesTable">
        <thead>
          <tr>
            <th>Lane</th><th>Equipment</th><th>Miles</th>
            <th>Posted Rate</th><th>Booked Rate</th><th>Spread</th><th>Booked RPM</th><th>Date</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="analytics" class="tab-content">
      <h2>üìä Performance Analytics</h2>

      <div class="controls-row">
        <div class="form-group" style="grid-column:span 3;"><label for="startDate">Start</label><input id="startDate" type="date"/></div>
        <div class="form-group" style="grid-column:span 3;"><label for="endDate">End</label><input id="endDate" type="date"/></div>
        <div class="form-group" style="grid-column:span 3;"><label for="equipSelect">Equipment</label>
          <select id="equipSelect"><option value="">All</option><option>R</option><option>V</option><option>F</option><option>VR</option></select>
        </div>
        <div class="run-actions"><button class="btn" id="runReportBtn">Run Report</button></div>
      </div>

      <div id="analyticsContent" class="subtle" style="margin-bottom:12px;">Analytics will appear here when you run a report‚Ä¶</div>
      <div id="noDataMsg" class="nodata" style="display:none;">No data in range for the selected filters.</div>

      <div style="margin-top:10px;">
        <h3>Rate per Mile over Time</h3>
        <canvas id="rpmChart" height="110"></canvas>
      </div>

      <div style="margin-top:24px;">
        <h3>Spread ($) over Time</h3>
        <canvas id="spreadChart" height="110"></canvas>
      </div>
    </div>

    <div id="directory" class="tab-content">
      <h2>üè≠ Shippers & üè¨ Receivers</h2>
      <div style="display:grid;grid-template-columns:1fr;gap:24px">
        <div>
          <h3>Shippers</h3>
          <table id="shippersTable">
            <thead>
              <tr>
                <th class="sortable" onclick="setDirectorySort('shippers','name')">Name <span id="shipSortName" class="sort-caret"></span></th>
                <th class="sortable" onclick="setDirectorySort('shippers','city')">City <span id="shipSortCity" class="sort-caret"></span></th>
                <th class="sortable" onclick="setDirectorySort('shippers','state')">State <span id="shipSortState" class="sort-caret"></span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div>
          <h3>Receivers</h3>
          <table id="receiversTable">
            <thead>
              <tr>
                <th class="sortable" onclick="setDirectorySort('receivers','name')">Name <span id="recvSortName" class="sort-caret"></span></th>
                <th class="sortable" onclick="setDirectorySort('receivers','city')">City <span id="recvSortCity" class="sort-caret"></span></th>
                <th class="sortable" onclick="setDirectorySort('receivers','state')">State <span id="recvSortState" class="sort-caret"></span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="subtle" style="margin-top:8px;">(We can add address, counts, and contact tracking next.)</div>
    </div>
  </div>

  <div id="editBackdrop" class="modal-backdrop" onclick="if(event.target.id==='editBackdrop') closeEdit()">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="editTitle">‚úèÔ∏è Edit Load</div>
        <button class="btn btn-danger" onclick="closeEdit()">‚úñ</button>
      </div>

      <div class="form-grid">
        <div class="form-group" style="grid-column:span 2;"><label for="editId">Load ID</label><input id="editId"/></div>
        <div class="form-group" style="grid-column:span 2;"><label for="editPick">Pickup Date</label><input id="editPick" type="date"/></div>
        <div class="form-group" style="grid-column:span 2;"><label for="editDel">Delivery Date</label><input id="editDel" type="date"/></div>
        <div class="form-group" style="grid-column:span 3;"><label for="editBroker">Broker Company</label><input id="editBroker"/></div>
        <div class="form-group" style="grid-column:span 3;"><label for="editContact">Contact Name</label><input id="editContact"/></div>

        <div class="form-group" style="grid-column:span 2;"><label for="editPhone">Phone</label><input id="editPhone"/></div>
        <div class="form-group" style="grid-column:span 1;"><label for="editExt">Ext</label><input id="editExt"/></div>
        <div class="form-group" style="grid-column:span 3;"><label for="editEmail">Email</label><input id="editEmail"/></div>

        <div class="form-group" style="grid-column:span 3;"><label for="editOrigin">Origin</label><input id="editOrigin"/></div>
        <div class="form-group" style="grid-column:span 3;"><label for="editDest">Destination</label><input id="editDest"/></div>
        <div class="form-group" style="grid-column:span 1;"><label for="editEquip">Equip</label><input id="editEquip"/></div>
        <div class="form-group" style="grid-column:span 2;"><label for="editMiles">Miles</label><input id="editMiles" type="number"/></div>
        <div class="form-group" style="grid-column:span 2;"><label for="editPosted">Posted Rate</label><input id="editPosted" type="number" step="0.01"/></div>
        <div class="form-group" style="grid-column:span 2;"><label for="editBooked">Booked Rate</label><input id="editBooked" type="number" step="0.01"/></div>

        <div class="form-group" style="grid-column:span 3;"><label for="editShipper">Shipper</label><input id="editShipper"/></div>
        <div class="form-group" style="grid-column:span 3;"><label for="editReceiver">Receiver</label><input id="editReceiver"/></div>
      </div>

      <div class="modal-actions">
        <button class="btn" onclick="saveEdit()">Save Changes</button>
        <button class="btn btn-danger" onclick="closeEdit()">Cancel</button>
      </div>
      <div id="editHint" class="subtle" style="margin-top:8px;"></div>
    </div>
  </div>

  <div id="contactBackdrop" class="modal-backdrop" onclick="if(event.target.id==='contactBackdrop') closeContact()">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="contactTitle" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="contactTitle">üìá Broker Contact</div>
        <button class="btn btn-danger" onclick="closeContact()">‚úñ</button>
      </div>

      <div class="field"><span class="label">Company:</span><span id="contactCompany"></span></div>
      <div class="field"><span class="label">Contact:</span><span id="contactName"></span></div>
      <div class="field"><span class="label">Phone:</span><span id="contactPhone"></span></div>
      <div class="field"><span class="label">Email:</span><span id="contactEmail"></span></div>

      <div class="modal-actions">
        <a class="btn" id="contactEmailBtn" href="#" target="_blank" rel="noopener">Email</a>
        <a class="btn" id="contactPhoneBtn" href="#" target="_blank" rel="noopener">Call</a>
        <button class="btn btn-danger" onclick="closeContact()">Close</button>
      </div>
    </div>
  </div>

  <div id="aiUploadBackdrop" class="modal-backdrop" onclick="if(event.target.id==='aiUploadBackdrop') closeAiImport()">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aiUploadTitle" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="aiUploadTitle">ü§ñ AI Import (PDF)</div>
        <button class="btn btn-danger" onclick="closeAiImport()">‚úñ</button>
      </div>

      <div id="aiDropZone" class="drop-zone" onclick="document.getElementById('aiFileInput').click()">
        <div class="spinner" id="aiSpinner"></div>
        <div class="drop-icon" style="font-size:3rem;">üìÑ</div>
        <div class="drop-text drop-icon">Click or Drag & Drop Rate Confirmation</div>
        <div class="drop-subtext drop-icon">Supports PDF files only</div>
        <input type="file" id="aiFileInput" class="file-input" accept="application/pdf" onchange="handleAiFile(this.files)">
      </div>

      <div class="modal-actions">
        <button class="btn btn-danger" onclick="closeAiImport()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="aiReviewBackdrop" class="modal-backdrop" onclick="if(event.target.id==='aiReviewBackdrop') closeAiReview()">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aiReviewTitle" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="aiReviewTitle">üìù Review AI Data</div>
        <button class="btn btn-danger" onclick="closeAiReview()">‚úñ</button>
      </div>
      <p class="subtle" style="margin-bottom:12px;">Please review the extracted data before saving.</p>

      <div class="form-grid">
        <div class="form-group" style="grid-column:span 2;"><label>Load ID</label><input id="aiId" /></div>
        <div class="form-group" style="grid-column:span 2;"><label>Pickup</label><input id="aiPick" type="date" /></div>
        <div class="form-group" style="grid-column:span 2;"><label>Delivery</label><input id="aiDel" type="date" /></div>
        <div class="form-group" style="grid-column:span 3;"><label>Broker</label><input id="aiBroker" /></div>
        <div class="form-group" style="grid-column:span 3;"><label>Contact</label><input id="aiContact" /></div>

        <div class="form-group" style="grid-column:span 2;"><label>Phone</label><input id="aiPhone" /></div>
        <div class="form-group" style="grid-column:span 1;"><label>Ext</label><input id="aiExt" /></div>
        <div class="form-group" style="grid-column:span 3;"><label>Email</label><input id="aiEmail" /></div>

        <div class="form-group" style="grid-column:span 3;"><label>Origin</label><input id="aiOrigin" /></div>
        <div class="form-group" style="grid-column:span 3;"><label>Destination</label><input id="aiDest" /></div>
        <div class="form-group" style="grid-column:span 1;"><label>Equip</label><input id="aiEquip" /></div>
        <div class="form-group" style="grid-column:span 2;"><label>Miles</label><input id="aiMiles" type="number"/></div>
        <div class="form-group" style="grid-column:span 2;"><label>Posted</label><input id="aiPosted" type="number" step="0.01"/></div>
        <div class="form-group" style="grid-column:span 2;"><label>Booked</label><input id="aiBooked" type="number" step="0.01"/></div>

        <div class="form-group" style="grid-column:span 3;"><label>Shipper</label><input id="aiShipper" /></div>
        <div class="form-group" style="grid-column:span 3;"><label>Receiver</label><input id="aiReceiver" /></div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-purple" onclick="saveAiLoad()">‚úÖ Save & Sync</button>
        <button class="btn btn-danger" onclick="closeAiReview()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------------------------------
    // APP PASSWORD HANDLING (SECURE)
    // ----------------------------------------------------
    let sessionPassword = ""; // Will store the entered password

    function doLogin() {
      const input = document.getElementById('loginPass').value;
      const errorMsg = document.getElementById('loginError');
      
      if(input && input.length > 0) {
        sessionPassword = input; // Store temporarily
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        // Trigger auto restore only after login
        autoRestoreIfEmpty();
      } else {
        errorMsg.style.display = 'block';
      }
    }

    // ----------------------
    // Global data & helpers
    // ----------------------
    const LOCAL_KEY = 'tms_loads';
    const UI_STATE_KEY = 'tms_ui_collapse';
    let loads = [];
    let rpmChartInstance = null;
    let spreadChartInstance = null;
    let statusFilter = ''; // '', 'Booked', 'Active', 'Completed'
    let editIndex = -1;
    let brokerQuery = '';
    let selectedYear = new Date().getFullYear();

    // Directory sorting state + helpers
    let dirSort = {
      shippers:  { key: 'name',  dir: 1 },   // dir: 1 = ASC, -1 = DESC
      receivers: { key: 'name',  dir: 1 }
    };
    function setDirectorySort(which, key){
      const cfg = dirSort[which];
      if(cfg.key === key){ cfg.dir = -cfg.dir; }
      else { cfg.key = key; cfg.dir = 1; }
      updateDirectoryTables();
    }
    function compareByKey(a, b, key, dir){
      const A = (a[key] || '').toString();
      const B = (b[key] || '').toString();
      return A.localeCompare(B, undefined, { sensitivity: 'base' }) * dir;
    }
    function setSortIndicators(){
      ['shipSortName','shipSortCity','shipSortState','recvSortName','recvSortCity','recvSortState']
        .forEach(id => { const el = document.getElementById(id); if(el) el.textContent=''; });

      const ship = dirSort.shippers;
      const recv = dirSort.receivers;
      const shipMap = { name:'shipSortName', city:'shipSortCity', state:'shipSortState' };
      const recvMap = { name:'recvSortName', city:'recvSortCity', state:'recvSortState' };
      const arrow = (dir)=> dir===1 ? '‚ñ≤' : '‚ñº';
      const shipEl = document.getElementById(shipMap[ship.key]); if(shipEl) shipEl.textContent = arrow(ship.dir);
      const recvEl = document.getElementById(recvMap[recv.key]); if(recvEl) recvEl.textContent = arrow(recv.dir);
    }

    // Safe load from localStorage
    try { const saved = localStorage.getItem(LOCAL_KEY); if(saved) loads = JSON.parse(saved) || []; } catch(e){ loads = []; }
    function saveData(){ localStorage.setItem(LOCAL_KEY, JSON.stringify(loads)); }
    function backupLocal(reason='manual'){
      try { localStorage.setItem(LOCAL_KEY+'_backup_'+Date.now()+'_'+reason, JSON.stringify(loads)); } catch(e) {}
    }
    function esc(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function telHref(phone){ const d = String(phone||'').replace(/[^\d+]/g,''); return d?('tel:'+d):'#'; }

    // ----------------------
    // Collapsible UI (animated, persisted)
    // ----------------------
    function getCollapseState(){
      try{ return JSON.parse(localStorage.getItem(UI_STATE_KEY) || '{}'); }catch(e){ return {}; }
    }
    function setCollapseState(obj){
      try{ localStorage.setItem(UI_STATE_KEY, JSON.stringify(obj)); }catch(e){}
    }
    function toggleCollapse(id){
      const el = document.getElementById(id);
      const body = el.querySelector('.collapse-body');
      const state = getCollapseState();
      const opening = !el.classList.contains('open');
      if(opening){
        el.classList.add('open');
        body.style.maxHeight = body.scrollHeight + 'px';
        state[id] = true;
      } else {
        body.style.maxHeight = body.scrollHeight + 'px';
        requestAnimationFrame(()=>{ body.style.maxHeight = '0'; });
        el.classList.remove('open');
        state[id] = false;
      }
      setCollapseState(state);
    }
    function restoreCollapse(){
      const state = getCollapseState();
      ['addCollapse','importCollapse'].forEach(id=>{
        const el = document.getElementById(id);
        const body = el.querySelector('.collapse-body');
        if(state[id]){
          el.classList.add('open');
          body.style.maxHeight = body.scrollHeight + 'px';
        } else {
          el.classList.remove('open');
          body.style.maxHeight = '0';
        }
      });
    }

    // ----------------------
    // Date helpers
    // ----------------------
    function parseMDY(s){
      if(!s) return new Date('Invalid');
      s = String(s).trim();
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T12:00:00');
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if(m) return new Date(+m[3], +m[1]-1, +m[2], 12,0,0,0);
      return new Date(s);
    }
    function toISODateLocal(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function endOfDayInclusive(d){ const t = new Date(d); t.setHours(23,59,59,999); return t; }
    function mdyFromInput(yyyy_mm_dd){ if(!yyyy_mm_dd) return ''; const [y,m,d]=yyyy_mm_dd.split('-'); return (+m)+'/'+(+d)+'/'+y; }
    function isoFromMDY(s){ const d = parseMDY(s); return isNaN(d) ? '' : toISODateLocal(d); }

    // ----------------------
    // Spread cutoff helpers
    // ----------------------
    const SPREAD_CUTOFF_MDY = '6/11/2025';
    const SPREAD_CUTOFF = parseMDY(SPREAD_CUTOFF_MDY);
    function computeSpread(load){
      const pick = parseMDY(load.pickupDate);
      if(!isNaN(pick) && pick < SPREAD_CUTOFF) return null;
      return Number(load.bookedRate||0) - Number(load.postedRate||0);
    }
    function renderSpreadCell(spreadVal){
      if (spreadVal == null || Number.isNaN(spreadVal)) return '<td>‚Äî</td>';
      const cls = spreadVal >= 0 ? 'revenue-positive' : 'revenue-negative';
      return `<td class="${cls}">$${spreadVal.toFixed(2)}</td>`;
    }

    // ----------------------
    // Status logic
    // ----------------------
    function computeStatusFromDates(pick, del){
      const pickup = parseMDY((pick||'').trim());
      const delivery = parseMDY((del||'').trim());
      const today = new Date(); today.setHours(12,0,0,0);
      if(isNaN(pickup) || isNaN(delivery)) return 'Completed';
      if(today < pickup) return 'Booked';
      if(pickup <= today && today <= delivery) return 'Active';
      return 'Completed';
    }
    function refreshStatuses(){
      let changed = false;
      for(const l of loads){
        if(l.statusLock){ if(l.status !== l.statusLock){ l.status = l.statusLock; changed = true; } continue; }
        const s = computeStatusFromDates(l.pickupDate, l.deliveryDate);
        if(l.status !== s){ l.status = s; changed = true; }
      }
      if(changed) saveData();
    }

    // ----------------------
    // Sorting helper for loads
    // ----------------------
    function sortLoadsByPickupDesc(){
      loads.sort((a,b)=> parseMDY(b.pickupDate) - parseMDY(a.pickupDate));
    }

    // ----------------------
    // Year selector (for revenue)
    // ----------------------
    function getYearsFromLoads(){
      const years = new Set();
      loads.forEach(l=>{
        const d = parseMDY(l.pickupDate);
        if(!isNaN(d)) years.add(d.getFullYear());
      });
      const arr = Array.from(years).sort((a,b)=>b-a);
      const current = new Date().getFullYear();
      if(!arr.includes(current)) arr.unshift(current);
      return arr;
    }
    function populateYearSelect(){
      const sel = document.getElementById('yearSelect');
      sel.innerHTML = '';
      const years = getYearsFromLoads();
      years.forEach(y=>{
        const opt = document.createElement('option');
        opt.value = String(y); opt.textContent = y;
        sel.appendChild(opt);
      });
      const all = document.createElement('option');
      all.value = 'all'; all.textContent = 'All Years';
      sel.appendChild(all);

      sel.value = String(selectedYear);
      sel.onchange = () => {
        selectedYear = sel.value === 'all' ? 'all' : parseInt(sel.value,10);
        updateStats();
      };
    }

    // ----------------------
    // Add new load
    // ----------------------
    function updateNewStatusHint(){
      const p = document.getElementById('newPick').value;
      const d = document.getElementById('newDel').value;
      const hint = document.getElementById('newStatusHint');
      if(p && d){ hint.textContent = 'Calculated status: ' + computeStatusFromDates(mdyFromInput(p), mdyFromInput(d)); }
      else { hint.textContent = ''; }
    }
    ['newPick','newDel'].forEach(id=>{
      document.addEventListener('input', e => { if(e.target && e.target.id===id) updateNewStatusHint(); });
    });

    function addNewLoad(){
      const id  = document.getElementById('newId').value.trim();
      const pIn = document.getElementById('newPick').value.trim();
      const dIn = document.getElementById('newDel').value.trim();
      if(!id || !pIn || !dIn){ alert('Load ID, Pickup and Delivery dates are required'); return; }

      const pickupDate = mdyFromInput(pIn);
      const deliveryDate = mdyFromInput(dIn);

      const pD = parseMDY(pickupDate), dD = parseMDY(deliveryDate);
      if(dD < pD){ alert('Delivery date must be on/after Pickup date.'); return; }

      const status = computeStatusFromDates(pickupDate, deliveryDate);

      const newLoad = {
        id, pickupDate, deliveryDate,
        brokerCompany: document.getElementById('newBroker').value.trim(),
        contact:       document.getElementById('newContact').value.trim(),
        phone:         document.getElementById('newPhone').value.trim(),
        extension:     document.getElementById('newExt').value.trim(),
        email:         document.getElementById('newEmail').value.trim(),
        origin:        document.getElementById('newOrigin').value.trim(),
        destination:   document.getElementById('newDest').value.trim(),
        equipment:    (document.getElementById('newEquip').value.trim()||'').toUpperCase(),
        miles:        parseInt(document.getElementById('newMiles').value.trim()) || 0,
        postedRate:   parseFloat(document.getElementById('newPosted').value.trim()) || 0,
        bookedRate:   parseFloat(document.getElementById('newBooked').value.trim()) || 0,
        shipper:      document.getElementById('newShipper').value.trim(),
        receiver:     document.getElementById('newReceiver').value.trim(),
        status,
        statusLock: null
      };

      backupLocal('before_add');
      loads.push(newLoad);
      sortLoadsByPickupDesc(); saveData();
      populateYearSelect();
      updateLoadsTable(); updateStats(); updateDirectoryTables();
      updateNewStatusHint();
      showMessage('New load added as '+status);

      ['newId','newBroker','newContact','newPhone','newExt','newEmail','newOrigin','newDest','newEquip','newMiles','newPosted','newBooked','newShipper','newReceiver'].forEach(i=>document.getElementById(i).value='');
    }

    // ----------------------
    // Import / Export
    // ----------------------
    function importLoads(){
      const csvData = document.getElementById('loadCsvInput').value;
      if(!csvData.trim()){ alert('Please paste load data first'); return; }
      const lines = csvData.split('\n');
      let count = 0;

      backupLocal('before_import');

      for(const raw of lines){
        const line = raw.trim();
        if(!line || line.toLowerCase().includes('load id')) continue;
        const parts = line.split(',');
        if(parts.length>=16){
          const pickupDate = parts[1].trim();
          const deliveryDate = parts[2].trim();
          const status = computeStatusFromDates(pickupDate, deliveryDate);

          const newLoad = {
            id: parts[0].trim(),
            pickupDate, deliveryDate,
            brokerCompany: parts[3].trim(),
            contact: parts[4].trim(),
            phone: parts[5].trim(),
            extension: parts[6].trim(),
            email: parts[7].trim(),
            origin: parts[8].trim(),
            destination: parts[9].trim(),
            equipment: (parts[10].trim()||'').toUpperCase(),
            miles: parseInt(parts[11].trim()) || 0,
            postedRate: parseFloat(parts[12].trim()) || 0,
            bookedRate: parseFloat(parts[13].trim()) || 0,
            shipper: parts[14].trim(),
            receiver: parts[15].trim(),
            status,
            statusLock: null
          };
          if(!loads.find(x=>x.id===newLoad.id)){ loads.push(newLoad); count++; }
        }
      }
      document.getElementById('loadCsvInput').value = '';
      sortLoadsByPickupDesc(); saveData(); refreshStatuses();
      populateYearSelect();
      updateLoadsTable(); updateStats(); updateDirectoryTables();
      showMessage(count + ' loads imported successfully!');
    }

    function exportData(){
      if(!loads.length){ alert('No data to export'); return; }
      const headers = ['Load ID','Pickup Date','Delivery Date','Broker Company','Contact Name','Phone','Extension','Email','Origin','Destination','Equipment','Miles','Posted Rate','Booked Rate','Shipper','Receiver','Status'];
      let csv = headers.join(',')+'\n';
      loads.forEach(l=>{
        csv += [l.id,l.pickupDate,l.deliveryDate,l.brokerCompany,l.contact,l.phone,l.extension||'',l.email,l.origin,l.destination,l.equipment,l.miles,l.postedRate,l.bookedRate,l.shipper||'',l.receiver||'',l.status].join(',')+'\n';
      });
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='TMS_Backup_'+new Date().toISOString().split('T')[0]+'.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      showMessage('Data exported successfully!');
    }

    function clearAllData(){
      if(confirm('‚ö†Ô∏è WARNING: This will delete ALL your data permanently. Are you sure?') && confirm('This action cannot be undone. Really delete everything?')){
        backupLocal('before_clear');
        localStorage.removeItem(LOCAL_KEY);
        loads = [];
        updateLoadsTable(); updateStats();
        document.querySelector('#brokersTable tbody').innerHTML='';
        document.querySelector('#lanesTable tbody').innerHTML='';
        document.querySelector('#shippersTable tbody').innerHTML='';
        document.querySelector('#receiversTable tbody').innerHTML='';
        destroyCharts();
        populateYearSelect();
        showMessage('All data cleared (backup saved in localStorage keys with _backup_)');
      }
    }

    // ----------------------
    // Status filter controls
    // ----------------------
    function setStatusFilter(v){
      statusFilter = v || '';
      document.getElementById('filterAll').classList.toggle('active', statusFilter==='');
      document.getElementById('filterBooked').classList.toggle('active', statusFilter==='Booked');
      document.getElementById('filterActive').classList.toggle('active', statusFilter==='Active');
      document.getElementById('filterCompleted').classList.toggle('active', statusFilter==='Completed');
      updateLoadsTable();
    }

    document.getElementById('activeLoadsCard').addEventListener('click', () => {
      showTab('loads');
      setStatusFilter('Active');
      document.getElementById('loadsTable').scrollIntoView({behavior:'smooth', block:'start'});
    });

    // ----------------------
    // Tab logic
    // ----------------------
    function showTab(tabName, ev){
      document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      if(ev && ev.target) ev.target.classList.add('active');

      if(tabName==='brokers')  updateBrokersTable();
      if(tabName==='lanes')    updateLanesTable();
      if(tabName==='directory') updateDirectoryTables();
      if(tabName==='analytics'){ initAnalyticsControls(); updateAnalytics(); attachAnalyticsRunHandlers(); }
    }

    // ----------------------
    // Loads table
    // ----------------------
    function updateLoadsTable(){
      refreshStatuses();
      const tbody = document.querySelector('#loadsTable tbody');
      tbody.innerHTML = '';

      const rows = loads
        .slice()
        .sort((a,b)=> parseMDY(b.pickupDate) - parseMDY(a.pickupDate))
        .filter(l => !statusFilter || l.status === statusFilter);

      rows.forEach((l,idx)=>{
        const rpm = l.miles>0 ? (l.bookedRate/l.miles).toFixed(2) : '0.00';
        const spreadVal = computeSpread(l);
        const statusClass = l.status==='Active' ? 'status-active' : (l.status==='Booked' ? 'status-booked' : 'status-completed');

        const tr = tbody.insertRow();
        tr.innerHTML =
          `<td>${esc(l.id)}</td>
           <td>${esc(l.pickupDate)}</td>
           <td>${esc(l.deliveryDate)}</td>
           <td>${esc(l.brokerCompany)}</td>
           <td>${esc(l.origin)} ‚Üí ${esc(l.destination)}</td>
           <td>${esc(l.equipment)}</td>
           <td>$${(l.bookedRate||0).toFixed(2)}</td>
           <td>${l.miles||0}</td>
           <td>$${rpm}</td>
           ${renderSpreadCell(spreadVal)}
           <td><span class="${statusClass}">${l.status}</span></td>
           <td>
             <button class="btn" onclick="openEdit(${idx})">Edit</button>
             <button class="btn btn-danger" onclick="deleteLoad(${idx})">Delete</button>
             ${l.status==='Active'?`<button class="btn" onclick="completeLoad(${idx})">Complete</button>`:''}
           </td>`;
      });
    }

    // ----------------------
    // Edit modal
    // ----------------------
    function openEdit(i){
      editIndex = i;
      const l = loads[i];
      document.getElementById('editId').value = l.id||'';
      document.getElementById('editPick').value = isoFromMDY(l.pickupDate)||'';
      document.getElementById('editDel').value  = isoFromMDY(l.deliveryDate)||'';
      document.getElementById('editBroker').value = l.brokerCompany||'';
      document.getElementById('editContact').value = l.contact||'';
      document.getElementById('editPhone').value = l.phone||'';
      document.getElementById('editExt').value = l.extension||'';
      document.getElementById('editEmail').value = l.email||'';
      document.getElementById('editOrigin').value = l.origin||'';
      document.getElementById('editDest').value = l.destination||'';
      document.getElementById('editEquip').value = l.equipment||'';
      document.getElementById('editMiles').value = l.miles||0;
      document.getElementById('editPosted').value = l.postedRate||0;
      document.getElementById('editBooked').value = l.bookedRate||0;
      document.getElementById('editShipper').value = l.shipper||'';
      document.getElementById('editReceiver').value = l.receiver||'';

      document.getElementById('editHint').textContent = 'Status is automatic (Booked/Active/Completed) unless you mark Complete.';
      document.getElementById('editBackdrop').style.display='flex';
    }
    function closeEdit(){ document.getElementById('editBackdrop').style.display='none'; editIndex=-1; }

    function saveEdit(){
      if(editIndex<0) return;
      const id  = document.getElementById('editId').value.trim();
      const pIn = document.getElementById('editPick').value.trim();
      const dIn = document.getElementById('editDel').value.trim();
      if(!id || !pIn || !dIn){ alert('Load ID, Pickup and Delivery dates are required'); return; }

      const pickupDate = mdyFromInput(pIn);
      const deliveryDate = mdyFromInput(dIn);
      const pD = parseMDY(pickupDate), dD = parseMDY(deliveryDate);
      if(dD < pD){ alert('Delivery date must be on/after Pickup date.'); return; }

      backupLocal('before_edit');

      const l = loads[editIndex];
      l.id = id; l.pickupDate = pickupDate; l.deliveryDate = deliveryDate;
      l.brokerCompany = document.getElementById('editBroker').value.trim();
      l.contact = document.getElementById('editContact').value.trim();
      l.phone = document.getElementById('editPhone').value.trim();
      l.extension = document.getElementById('editExt').value.trim();
      l.email = document.getElementById('editEmail').value.trim();
      l.origin = document.getElementById('editOrigin').value.trim();
      l.destination = document.getElementById('editDest').value.trim();
      l.equipment = (document.getElementById('editEquip').value.trim()||'').toUpperCase();
      l.miles = parseInt(document.getElementById('editMiles').value.trim()) || 0;
      l.postedRate = parseFloat(document.getElementById('editPosted').value.trim()) || 0;
      l.bookedRate = parseFloat(document.getElementById('editBooked').value.trim()) || 0;
      l.shipper = document.getElementById('editShipper').value.trim();
      l.receiver= document.getElementById('editReceiver').value.trim();

      if(!l.statusLock){ l.status = computeStatusFromDates(l.pickupDate, l.deliveryDate); }

      sortLoadsByPickupDesc(); saveData(); closeEdit(); updateLoadsTable(); updateStats(); updateDirectoryTables(); showMessage('Load updated');
    }

    // ----------------------
    // Contact modal (from lanes)
    // ----------------------
    function openContact(index){
      const l = loads[index];
      if(!l){ alert('Could not find this load'); return; }
      const emailHtml = l.email ? `<a class="mail" href="mailto:${esc(l.email)}">${esc(l.email)}</a>` : '<span class="subtle">No email</span>';
      document.getElementById('contactCompany').innerHTML = esc(l.brokerCompany || '(Unknown Company)');
      document.getElementById('contactName').innerHTML    = esc(l.contact || '(No contact)');
      document.getElementById('contactPhone').innerHTML   = esc(l.phone || '');
      document.getElementById('contactEmail').innerHTML   = emailHtml;

      const emailBtn = document.getElementById('contactEmailBtn');
      const phoneBtn = document.getElementById('contactPhoneBtn');
      if(l.email){ emailBtn.href = 'mailto:'+encodeURIComponent(l.email); emailBtn.style.display='inline-flex'; } else { emailBtn.href='#'; emailBtn.style.display='none'; }
      if(l.phone){ phoneBtn.href = telHref(l.phone);                        phoneBtn.style.display='inline-flex'; } else { phoneBtn.href='#'; phoneBtn.style.display='none'; }
      document.getElementById('contactBackdrop').style.display='flex';
    }
    function closeContact(){ document.getElementById('contactBackdrop').style.display='none'; }

    // ----------------------
    // Broker search + table
    // ----------------------
    function applyBrokerSearch(){
      brokerQuery = (document.getElementById('brokerSearchInput').value||'').trim().toLowerCase();
      updateBrokersTable();
    }
    function clearBrokerSearch(){
      brokerQuery = '';
      document.getElementById('brokerSearchInput').value='';
      updateBrokersTable();
    }
    document.getElementById('brokerSearchInput').addEventListener('keydown', e=>{
      if(e.key==='Enter') applyBrokerSearch();
    });

    function updateBrokersTable(){
      const tbody = document.querySelector('#brokersTable tbody');
      tbody.innerHTML = '';
      const byCompany = {};
      loads.forEach(l=>{
        const comp = l.brokerCompany || '(Unknown Company)';
        if(!byCompany[comp]) byCompany[comp] = { contacts:{}, all:[] };
        const ck = (l.contact||'(No contact)').trim();
        if(!byCompany[comp].contacts[ck]){
          byCompany[comp].contacts[ck] = { phone:l.phone||'', email:l.email||'', loads:[] };
        }
        byCompany[comp].contacts[ck].loads.push(l);
        byCompany[comp].all.push(l);
      });

      Object.keys(byCompany)
        .filter(c => !brokerQuery || c.toLowerCase().includes(brokerQuery))
        .sort((a,b)=>a.localeCompare(b))
        .forEach(company=>{
          const group = byCompany[company];
          const totalLoadsCompany = group.all.length;
          const totalRevenueCompany = group.all.filter(l=>l.status==='Completed').reduce((s,l)=>s+l.bookedRate,0);

          const head = tbody.insertRow();
          head.className = 'company-header';
          head.innerHTML =
            `<td class="company-name">${esc(company)}</td>
             <td></td><td></td><td></td>
             <td>${totalLoadsCompany}</td>
             <td class="revenue-positive">$${totalRevenueCompany.toFixed(2)}</td>
             <td></td>`;
          Object.keys(group.contacts).sort((a,b)=>a.localeCompare(b)).forEach(contact=>{
            const info = group.contacts[contact];
            const loadsFor = info.loads;
            const lastLoadDate = loadsFor.length
              ? loadsFor.slice().sort((x,y)=> parseMDY(y.pickupDate)-parseMDY(x.pickupDate))[0].pickupDate
              : 'N/A';
            const totalRevenue = loadsFor.filter(l=>l.status==='Completed').reduce((s,l)=>s+l.bookedRate,0);
            const emailCell = info.email ? `<a class="mail" href="mailto:${esc(info.email)}">${esc(info.email)}</a>` : '';

            const tr = tbody.insertRow();
            tr.innerHTML =
              `<td>${esc(company)}</td>
               <td>${esc(contact)}</td>
               <td>${esc(info.phone)}</td>
               <td>${emailCell}</td>
               <td>${loadsFor.length}</td>
               <td class="revenue-positive">$${totalRevenue.toFixed(2)}</td>
               <td>${esc(lastLoadDate)}</td>`;
          });
        });
    }

    // ----------------------
    // Lanes + filters
    // ----------------------
    let laneFilterFrom = '', laneFilterTo = '', laneFilterEquip = '';
    function applyLaneFilter(){
      laneFilterFrom = document.getElementById('fromInput').value.trim();
      laneFilterTo   = document.getElementById('toInput').value.trim();
      laneFilterEquip= document.getElementById('equipFilter').value.trim();
      updateLanesTable();
    }
    function resetLaneFilter(){
      document.getElementById('fromInput').value='';
      document.getElementById('toInput').value='';
      document.getElementById('equipFilter').value='';
      laneFilterFrom = laneFilterTo = laneFilterEquip = '';
      updateLanesTable();
    }
    function normalizePlace(s){
      if(!s) return { city:'', state:'' };
      const raw=s.trim();
      if(raw.includes(',')){
        const [city, rest]=raw.split(',').map(x=>x.trim());
        const parts = rest.split(' '); const st = parts.pop()||'';
        return { city, state:st.toUpperCase() };
      } else {
        const parts = raw.split(' ');
        if(parts.length===1 && parts[0].length<=3) return { city:'', state:parts[0].toUpperCase() };
        const st = parts.pop()||''; return { city:parts.join(' '), state:st.toUpperCase() };
      }
    }
    function laneMatches(load, fromQ, toQ, equipQ){
      const orig = normalizePlace((load.origin||'').replace(/-/g,' ').replace('‚Üí',' '));
      const dest = normalizePlace((load.destination||'').replace(/-/g,' ').replace('‚Üí',' '));
      if(equipQ && (load.equipment||'').toUpperCase() !== equipQ.toUpperCase()) return false;

      if(fromQ){
        const f = normalizePlace(fromQ);
        const fText = fromQ.toLowerCase();
        const origText = (load.origin||'').toLowerCase();
        if(f.city==='' && f.state){ if(orig.state !== f.state) return false; }
        else {
          const cityOk = f.city ? orig.city.toLowerCase().includes(f.city.toLowerCase()) : true;
          const stateOk = f.state ? (orig.state === f.state) : true;
          if(!(cityOk && stateOk) && !origText.includes(fText)) return false;
        }
      }
      if(toQ){
        const t = normalizePlace(toQ);
        const tText = toQ.toLowerCase();
        const destText = (load.destination||'').toLowerCase();
        if(t.city==='' && t.state){ if(dest.state !== t.state) return false; }
        else {
          const cityOk = t.city ? dest.city.toLowerCase().includes(t.city.toLowerCase()) : true;
          const stateOk = t.state ? (dest.state === t.state) : true;
          if(!(cityOk && stateOk) && !destText.includes(tText)) return false;
        }
      }
      return true;
    }
    function updateLanesTable(){
      const tbody = document.querySelector('#lanesTable tbody');
      tbody.innerHTML = '';

      const annotated = loads.map((l, idx)=> ({...l, __i: idx}));
      annotated
        .slice()
        .sort((a,b)=> parseMDY(b.pickupDate)-parseMDY(a.pickupDate))
        .filter(l=>laneMatches(l, laneFilterFrom, laneFilterTo, laneFilterEquip))
        .forEach(l=>{
          const spreadVal = computeSpread(l);
          const rpm = l.miles>0 ? (l.bookedRate/l.miles).toFixed(2) : '0.00';
          const tr = tbody.insertRow();
          tr.innerHTML =
            `<td>${esc(l.origin)} ‚Üí ${esc(l.destination)}</td>
             <td>${esc(l.equipment)}</td>
             <td>${l.miles||0}</td>
             <td>$${(l.postedRate||0).toFixed(2)}</td>
             <td>$${(l.bookedRate||0).toFixed(2)}</td>
             ${renderSpreadCell(spreadVal)}
             <td>$${rpm}</td>
             <td>${esc(l.pickupDate)}</td>
             <td><button class="btn" onclick="openContact(${l.__i})">Contact</button></td>`;
        });
      updateStats();
    }

    // ----------------------
    // Shippers & Receivers Directory (sortable)
    // ----------------------
    function uniqueByKey(items, keyFn){
      const map = new Map();
      items.forEach(it=>{
        const key = keyFn(it);
        if(!map.has(key)) map.set(key, it);
      });
      return Array.from(map.values());
    }
    function updateDirectoryTables(){
      const shipBody = document.querySelector('#shippersTable tbody');
      const recvBody = document.querySelector('#receiversTable tbody');
      shipBody.innerHTML = ''; recvBody.innerHTML = '';

      // Shippers
      const shippers = loads
        .filter(l => (l.shipper||'').trim())
        .map(l => {
          const o = normalizePlace(l.origin||'');
          return { name:(l.shipper||'').trim(), city:o.city, state:o.state };
        });
      const uniqueShippers = uniqueByKey(shippers, s => `${s.name}|${s.city}|${s.state}`)
        .sort((a,b)=> compareByKey(a,b, dirSort.shippers.key, dirSort.shippers.dir));

      uniqueShippers.forEach(s=>{
        const tr = shipBody.insertRow();
        tr.innerHTML = `<td>${esc(s.name)}</td><td>${esc(s.city)}</td><td>${esc(s.state)}</td>`;
      });

      // Receivers
      const receivers = loads
        .filter(l => (l.receiver||'').trim())
        .map(l => {
          const d = normalizePlace(l.destination||'');
          return { name:(l.receiver||'').trim(), city:d.city, state:d.state };
        });
      const uniqueReceivers = uniqueByKey(receivers, s => `${s.name}|${s.city}|${s.state}`)
        .sort((a,b)=> compareByKey(a,b, dirSort.receivers.key, dirSort.receivers.dir));

      uniqueReceivers.forEach(s=>{
        const tr = recvBody.insertRow();
        tr.innerHTML = `<td>${esc(s.name)}</td><td>${esc(s.city)}</td><td>${esc(s.state)}</td>`;
      });

      setSortIndicators();
    }

    // ----------------------
    // Stats + Overview / Analytics
    // ----------------------
    function updateStats(){
      refreshStatuses();

      document.getElementById('totalBrokers').textContent = new Set(loads.map(l=>l.brokerCompany)).size;
      document.getElementById('totalLanes').textContent   = new Set(loads.map(l=>`${l.origin} ‚Üí ${l.destination}`)).size;

      const activeCount    = loads.filter(l=>l.status==='Active').length;
      const completedCount = loads.filter(l=>l.status==='Completed').length;
      document.getElementById('activeLoads').textContent    = activeCount;
      document.getElementById('completedLoads').textContent = completedCount;

      let yearRevenue;
      if(selectedYear === 'all'){
        yearRevenue = loads.filter(l=>l.status==='Completed').reduce((s,l)=>s+l.bookedRate,0);
      } else {
        yearRevenue = loads
          .filter(l=>{
            if(l.status!=='Completed') return false;
            const d = parseMDY(l.pickupDate);
            return !isNaN(d) && d.getFullYear()===selectedYear;
          })
          .reduce((s,l)=>s+l.bookedRate,0);
      }
      document.getElementById('totalRevenue').textContent = '$'+yearRevenue.toFixed(2);

      const avg = loads.length ? (loads.reduce((s,l)=>s+(l.miles?l.bookedRate/l.miles:0),0)/loads.length) : 0;
      document.getElementById('avgRPM').textContent = '$'+avg.toFixed(2);
    }

    function updateAnalytics(){
      const content = document.getElementById('analyticsContent');
      if(!loads.length){ content.textContent='Add some load data to see analytics‚Ä¶'; return; }
      const active = loads.filter(l=>l.status==='Active').length;
      const completed = loads.filter(l=>l.status==='Completed').length;
      const totalRevenue = loads.filter(l=>l.status==='Completed').reduce((s,l)=>s+l.bookedRate,0);
      const uniqueBrokers = new Set(loads.map(l=>l.brokerCompany)).size;
      const uniqueLanes = new Set(loads.map(l=>`${l.origin} ‚Üí ${l.destination}`)).size;
      content.innerHTML =
        `<p><strong>Total Loads:</strong> ${loads.length}</p>
         <p><strong>Active Loads:</strong> ${active}</p>
         <p><strong>Completed Loads:</strong> ${completed}</p>
         <p><strong>Broker Partners:</strong> ${uniqueBrokers}</p>
         <p><strong>Historical Lanes:</strong> ${uniqueLanes}</p>
         <p><strong>Total Revenue:</strong> $${totalRevenue.toFixed(2)}</p>`;
    }

    // Charts
    function initAnalyticsControls(){
      const sd = document.getElementById('startDate');
      const ed = document.getElementById('endDate');
      const dates = loads.map(l=>parseMDY(l.pickupDate)).filter(d=>!isNaN(d));
      if(!dates.length) return;
      const minD = new Date(Math.min(...dates));
      const maxD = new Date(Math.max(...dates));
      if(!sd.value) sd.value = toISODateLocal(minD);
      if(!ed.value) ed.value = toISODateLocal(maxD);
      renderCharts();
    }
    function attachAnalyticsRunHandlers(){
      document.getElementById('runReportBtn').onclick = renderCharts;
      [document.getElementById('startDate'), document.getElementById('endDate'), document.getElementById('equipSelect')]
        .forEach(el=> el.onkeydown = e => { if(e.key==='Enter') renderCharts(); });
    }
    function destroyCharts(){ if(rpmChartInstance){rpmChartInstance.destroy(); rpmChartInstance=null;} if(spreadChartInstance){spreadChartInstance.destroy(); spreadChartInstance=null;} }
    function renderCharts(){
      if(!loads.length){ destroyCharts(); return; }
      const equip = document.getElementById('equipSelect').value;
      const sdVal = document.getElementById('startDate').value;
      const edVal = document.getElementById('endDate').value;
      const sd = sdVal ? new Date(sdVal) : null;
      const ed = edVal ? endOfDayInclusive(new Date(edVal)) : null;

      const filtered = loads
        .filter(l=>!equip || l.equipment===equip)
        .map(l=> ({...l, d: parseMDY(l.pickupDate)}))
        .filter(o=> !isNaN(o.d) && (!sd || o.d>=sd) && (!ed || o.d<=ed))
        .sort((a,b)=> a.d - b.d);

      const buckets = new Map();
      filtered.forEach(l=>{
        const d = new Date(l.d.getFullYear(), l.d.getMonth(), l.d.getDate());
        const key = d.getTime();
        if(!buckets.has(key)) buckets.set(key,{date:d, rpms:[], spreads:[]});
        buckets.get(key).rpms.push(l.miles? (l.bookedRate/l.miles) : 0);
        const sVal = computeSpread(l);
        if (sVal != null && !Number.isNaN(sVal)) buckets.get(key).spreads.push(sVal);
      });

      const series = Array.from(buckets.values()).sort((a,b)=>a.date-b.date);
      const rpmData = series.map(s=>({x:s.date, y: s.rpms.reduce((a,b)=>a+b,0)/s.rpms.length}));
      const spreadData = series.map(s=>{
        if(!s.spreads.length) return {x:s.date, y: null};
        return {x:s.date, y: s.spreads.reduce((a,b)=>a+b,0)/s.spreads.length};
      });

      document.getElementById('noDataMsg').style.display = series.length ? 'none' : 'block';
      destroyCharts();

      const rpmCtx = document.getElementById('rpmChart').getContext('2d');
      rpmChartInstance = new Chart(rpmCtx, {
        type:'line',
        data:{ datasets:[{ label:`RPM ${equip?('('+equip+')'):''} ‚Äî Daily`, data:rpmData, tension:0.25 }]},
        options:{ responsive:true, parsing:false, scales:{ x:{ type:'time', min: sd||undefined, max: ed||undefined, time:{ unit:'day' } }, y:{ beginAtZero:true, title:{display:true,text:'$ / mile'} } } }
      });

      const spreadCtx = document.getElementById('spreadChart').getContext('2d');
      spreadChartInstance = new Chart(spreadCtx, {
        type:'line',
        data:{ datasets:[{ label:`Spread ${equip?('('+equip+')'):''} ‚Äî Daily`, data:spreadData, tension:0.25 }]},
        options:{ responsive:true, parsing:false, scales:{ x:{ type:'time', min: sd||undefined, max: ed||undefined, time:{ unit:'day' } }, y:{ beginAtZero:true, title:{display:true,text:'Spread ($)'}, ticks:{ callback:v=>'$'+Number(v).toFixed(0) } } } }
      });
    }

    // ----------------------
    // Actions
    // ----------------------
    function deleteLoad(i){
      if(confirm('Delete this load?')){
        backupLocal('before_delete');
        loads.splice(i,1); sortLoadsByPickupDesc(); saveData(); updateLoadsTable(); updateStats(); updateDirectoryTables();
      }
    }
    function completeLoad(i){
      if(!confirm('Mark this load as completed?')) return;
      backupLocal('before_complete');
      loads[i].statusLock = 'Completed';
      loads[i].status     = 'Completed';
      sortLoadsByPickupDesc(); saveData();
      updateLoadsTable(); updateStats();
      showMessage('Load marked as completed!');
    }

    function showMessage(message){
      const d = document.createElement('div'); d.className='success-message'; d.textContent=message;
      document.body.appendChild(d); setTimeout(()=>{ if(document.body.contains(d)) document.body.removeChild(d); },3000);
    }

    // ----------------------
    // Cloud (Supabase)
    // ----------------------
    const SUPABASE_URL = 'https://saqppcruujjeouqqvrgr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhcXBwY3J1dWpqZW91cXF2cmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDI0NTcsImV4cCI6MjA3NDk3ODQ1N30.0jxb44Sn7VNqaEeI_i8kheufXLAtAk_sWrYaJJDiMd0';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function mergeIncoming(incoming){
      const map = new Map(loads.map(l=>[l.id, l]));
      let added = 0, updated = 0;
      for(const r of incoming){
        const normalized = {
          id: r.id,
          pickupDate: r.pickup_date || r.pickupDate,
          deliveryDate: r.delivery_date || r.deliveryDate,
          brokerCompany: r.broker_company || r.brokerCompany,
          contact: r.contact ?? '',
          phone: r.phone ?? '',
          extension: r.extension ?? '',
          email: r.email ?? '',
          origin: r.origin ?? '',
          destination: r.destination ?? '',
          equipment: r.equipment ?? '',
          miles: Number(r.miles||0),
          postedRate: Number(r.posted_rate ?? r.postedRate ?? 0),
          bookedRate: Number(r.booked_rate ?? r.bookedRate ?? 0),
          shipper: r.shipper ?? '',
          receiver: r.receiver ?? '',
          status: r.status ?? 'Completed',
          statusLock: null
        };
        if(!map.has(normalized.id)){ map.set(normalized.id, normalized); added++; }
        else {
          const local = map.get(normalized.id);
          const dp = parseMDY(normalized.pickupDate);
          const lp = parseMDY(local.pickupDate);
          if(!isNaN(dp) && (isNaN(lp) || dp > lp)){ map.set(normalized.id, normalized); updated++; }
        }
      }
      loads = Array.from(map.values());
      sortLoadsByPickupDesc(); saveData();
      return {added, updated};
    }

    async function restoreFromCloud(){
      const btn = event?.target;
      if(btn){ btn.disabled = true; btn.textContent = 'Restoring...'; }
      try{
        const { data, error } = await db.from('loads').select('*').order('pickup_date', {ascending:false});
        if(error) throw error;
        if(!data || !data.length){ alert('No rows found in cloud.'); return; }

        backupLocal('before_restore');
        const {added, updated} = mergeIncoming(data);
        populateYearSelect();
        updateLoadsTable(); updateStats(); updateLanesTable(); updateDirectoryTables(); renderCharts();
        alert(`Restore complete. Added ${added}, updated ${updated}.`);
      } catch(err){
        alert('Restore failed: '+err.message);
      } finally {
        if(btn){ btn.disabled = false; btn.textContent = 'üîÑ Restore from Cloud'; }
      }
    }

    async function syncToCloud() {
      if (!loads.length) { return; } // Removed alert if calling programmatically, kept for manual button
      const btn = event?.target;
      if(btn && btn.textContent){ btn.disabled = true; btn.textContent = 'Syncing...'; }
      try {
        backupLocal('before_sync');

        const dataToSync = loads.map(l => ({
          id: l.id,
          pickup_date: l.pickupDate,
          delivery_date: l.deliveryDate,
          broker_company: l.brokerCompany,
          contact: l.contact,
          phone: l.phone,
          extension: l.extension,
          email: l.email,
          origin: l.origin,
          destination: l.destination,
          equipment: l.equipment,
          miles: l.miles,
          posted_rate: l.postedRate,
          booked_rate: l.bookedRate,
          shipper: l.shipper,
          receiver: l.receiver,
          status: l.status
        }));

        const { error } = await db.from('loads').upsert(dataToSync, { onConflict: 'id' });
        if (error) throw error;
        if(btn) alert(`Successfully synced ${loads.length} loads to cloud (upsert).`);
      } catch (error) {
        if(btn) alert('Sync failed: ' + error.message);
      } finally {
        if(btn && btn.textContent){ btn.disabled = false; btn.textContent = '‚òÅÔ∏è Sync to Cloud (Upsert)'; }
      }
    }

    async function autoRestoreIfEmpty(){
      if(loads.length) return;
      try{
        const { data, error } = await db.from('loads').select('id').limit(1);
        if(error) return;
        if(data && data.length){ await restoreFromCloud(); }
      } catch(e){}
    }

    // ----------------------------------------------------
    // AI IMPORT FEATURE (New Module)
    // ----------------------------------------------------

    function openAiImport(){
      document.getElementById('aiUploadBackdrop').style.display='flex';
    }
    function closeAiImport(){
      document.getElementById('aiUploadBackdrop').style.display='none';
      document.getElementById('aiSpinner').style.display = 'none';
      document.getElementById('aiDropZone').classList.remove('processing');
    }

    function openAiReview(data){
      closeAiImport();
      var data = response.data;
      // Populate fields. API uses snake_case, TMS uses DOM IDs.
      document.getElementById('aiId').value = data.id || '';
      // Ensure date format YYYY-MM-DD
      document.getElementById('aiPick').value = data.pickup_date || '';
      document.getElementById('aiDel').value = data.delivery_date || '';
      document.getElementById('aiBroker').value = data.broker_company || '';
      document.getElementById('aiContact').value = data.contact || '';
      document.getElementById('aiPhone').value = data.phone || '';
      document.getElementById('aiExt').value = data.extension || '';
      document.getElementById('aiEmail').value = data.email || '';
      document.getElementById('aiOrigin').value = data.origin || '';
      document.getElementById('aiDest').value = data.destination || '';
      document.getElementById('aiEquip').value = data.equipment || '';
      document.getElementById('aiMiles').value = data.miles || '';
      document.getElementById('aiPosted').value = data.posted_rate || '';
      document.getElementById('aiBooked').value = data.booked_rate || '';
      document.getElementById('aiShipper').value = data.shipper || '';
      document.getElementById('aiReceiver').value = data.receiver || '';

      document.getElementById('aiReviewBackdrop').style.display='flex';
    }
    function closeAiReview(){
      document.getElementById('aiReviewBackdrop').style.display='none';
    }

    // Drag and Drop Logic
    var dropZone = document.getElementById('aiDropZone');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
      dropZone.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Highlight drop zone
    ['dragenter', 'dragover'].forEach(function(eventName) {
      dropZone.addEventListener(eventName, function() { dropZone.classList.add('dragover'); }, false);
    });

    ['dragleave', 'drop'].forEach(function(eventName) {
      dropZone.addEventListener(eventName, function() { dropZone.classList.remove('dragover'); }, false);
    });

    // Handle dropped files
    dropZone.addEventListener('drop', function(e) {
      var dt = e.dataTransfer;
      var files = dt.files;
      handleAiFile(files);
    }, false);

    function handleAiFile(files) {
      if (files.length === 0) return;
      var file = files[0];
      if (file.type !== 'application/pdf') {
        alert('Please upload a PDF file.');
        return;
      }

      // Show spinner
      dropZone.classList.add('processing');
      document.getElementById('aiSpinner').style.display = 'block';

      // Read file as Base64
      var reader = new FileReader();
      reader.onload = function(e) {
        var base64 = e.target.result.split(',')[1]; // Remove data:application/pdf;base64, prefix
        sendToAiApi(base64);
      };
      reader.readAsDataURL(file);
    }

    function sendToAiApi(base64Data) {
      var API_URL = '/api/parse-rateconf';
      
      // We use the password the user typed at the login screen
      var payload = { 
        pdfBase64: base64Data,
        password: sessionPassword
      };

      fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
      .then(function(response) {
        if (!response.ok) throw new Error('API processing failed. Check password?');
        return response.json();
      })
      .then(function(data) {
        openAiReview(data);
      })
      .catch(function(error) {
        alert('Error processing PDF: ' + error.message);
        closeAiImport();
      });
    }

    function saveAiLoad() {
      // 1. Gather data from Review Modal
      var id = document.getElementById('aiId').value.trim();
      var pIn = document.getElementById('aiPick').value.trim(); // yyyy-mm-dd
      var dIn = document.getElementById('aiDel').value.trim();

      if(!id || !pIn || !dIn) {
        alert('Load ID, Pickup and Delivery dates are required');
        return;
      }

      // 2. Convert to TMS Internal Format (camelCase + MM/DD/YYYY dates)
      var pickupDate = mdyFromInput(pIn);
      var deliveryDate = mdyFromInput(dIn);
      var status = computeStatusFromDates(pickupDate, deliveryDate);

      var newLoad = {
        id: id,
        pickupDate: pickupDate,
        deliveryDate: deliveryDate,
        brokerCompany: document.getElementById('aiBroker').value.trim(),
        contact: document.getElementById('aiContact').value.trim(),
        phone: document.getElementById('aiPhone').value.trim(),
        extension: document.getElementById('aiExt').value.trim(),
        email: document.getElementById('aiEmail').value.trim(),
        origin: document.getElementById('aiOrigin').value.trim(),
        destination: document.getElementById('aiDest').value.trim(),
        equipment: (document.getElementById('aiEquip').value.trim()||'').toUpperCase(),
        miles: parseInt(document.getElementById('aiMiles').value.trim()) || 0,
        postedRate: parseFloat(document.getElementById('aiPosted').value.trim()) || 0,
        bookedRate: parseFloat(document.getElementById('aiBooked').value.trim()) || 0,
        shipper: document.getElementById('aiShipper').value.trim(),
        receiver: document.getElementById('aiReceiver').value.trim(),
        status: status,
        statusLock: null
      };

      // 3. Save Locally
      backupLocal('before_ai_add');
      
      // Check for duplicate ID
      var existingIndex = loads.findIndex(function(x) { return x.id === newLoad.id; });
      if(existingIndex >= 0) {
        if(confirm('Load ID ' + newLoad.id + ' already exists. Overwrite?')) {
          loads[existingIndex] = newLoad;
        } else {
          return;
        }
      } else {
        loads.push(newLoad);
      }

      sortLoadsByPickupDesc();
      saveData();
      
      // 4. Update UI
      populateYearSelect();
      updateLoadsTable();
      updateStats();
      updateDirectoryTables();
      
      // 5. Sync & Close
      closeAiReview();
      showMessage('AI Import Saved Successfully!');
      syncToCloud(); // Trigger sync automatically
    }

    // ----------------------
    // Init
    // ----------------------
    window.onload = async function(){
      restoreCollapse();
      refreshStatuses();
      sortLoadsByPickupDesc();
      populateYearSelect();
      updateLoadsTable();
      updateStats();
      updateBrokersTable();
      updateLanesTable();
      updateDirectoryTables();
      // await autoRestoreIfEmpty(); // Moved to login success
    };
  </script>
</body>
</html>
