<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxon TMS - Transportation Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Auth Container (Login/Register) -->
    <div id="authContainer" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Luxon TMS</h1>
                <p class="text-gray-500 mt-2">Transportation Management System</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <h2 class="text-xl font-semibold mb-6">Sign In</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="you@company.com">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="loginPassword" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button type="submit" id="loginBtn"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                        <span>Sign In</span>
                    </button>
                </form>
                <p class="text-center mt-4 text-sm text-gray-600">
                    Don't have an account? 
                    <button onclick="showRegister()" class="text-blue-600 hover:underline">Create one</button>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h2 class="text-xl font-semibold mb-6">Create Account</h2>
                <form onsubmit="handleRegister(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="registerName" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="John Doe">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                        <input type="text" id="registerCompany"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Your Trucking Co.">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="registerEmail" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="you@company.com">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="registerPassword" required minlength="6"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Min 6 characters">
                    </div>
                    <button type="submit" id="registerBtn"
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center justify-center">
                        <span>Create Account</span>
                    </button>
                </form>
                <p class="text-center mt-4 text-sm text-gray-600">
                    Already have an account? 
                    <button onclick="showLogin()" class="text-blue-600 hover:underline">Sign in</button>
                </p>
            </div>

            <!-- Auth Error Message -->
            <div id="authError" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
            <div id="authSuccess" class="hidden mt-4 p-3 bg-green-100 text-green-700 rounded-lg text-sm"></div>
        </div>
    </div>

    <!-- Main App Container (shown after login) -->
    <div id="appContainer" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-gray-800">Luxon TMS</h1>
                    <span class="text-sm text-gray-500" id="userEmail"></span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-600" id="userName"></span>
                    <button onclick="handleLogout()" 
                        class="text-sm text-red-600 hover:text-red-800 font-medium">
                        Sign Out
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Upload Rate Confirmation -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="font-semibold text-lg mb-4">ðŸ“„ Import Rate Confirmation</h3>
                    <p class="text-gray-600 text-sm mb-4">Upload a PDF rate confirmation to automatically extract load details using AI.</p>
                    <label class="block">
                        <input type="file" id="pdfUpload" accept=".pdf" onchange="handlePdfUpload(event)" class="hidden">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition">
                            <div id="uploadStatus">
                                <span class="text-gray-500">Click or drag PDF here</span>
                            </div>
                        </div>
                    </label>
                </div>

                <!-- Add Manual Load -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="font-semibold text-lg mb-4">âž• Add Load Manually</h3>
                    <p class="text-gray-600 text-sm mb-4">Create a new load entry by entering the details yourself.</p>
                    <button onclick="showAddLoadModal()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        Add New Load
                    </button>
                </div>

                <!-- Stats -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="font-semibold text-lg mb-4">ðŸ“Š Quick Stats</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Loads:</span>
                            <span class="font-semibold" id="totalLoads">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Pending:</span>
                            <span class="font-semibold text-yellow-600" id="pendingLoads">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Completed:</span>
                            <span class="font-semibold text-green-600" id="completedLoads">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loads Table -->
            <div class="bg-white rounded-xl shadow">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold">Your Loads</h2>
                        <div class="flex items-center gap-4">
                            <input type="text" id="searchLoads" placeholder="Search loads..." 
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                onkeyup="debounce(loadLoads, 300)()">
                            <select id="statusFilter" onchange="loadLoads()" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="booked">Booked</option>
                                <option value="in_transit">In Transit</option>
                                <option value="delivered">Delivered</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Load #</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Broker</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Route</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pickup</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Delivery</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rate</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loadsTableBody" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                    Loading loads...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Load Modal -->
    <div id="loadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold" id="modalTitle">Add New Load</h3>
            </div>
            <form onsubmit="handleSaveLoad(event)" class="p-6">
                <input type="hidden" id="loadId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Load Number</label>
                        <input type="text" id="loadNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Broker Name</label>
                        <input type="text" id="brokerName" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Broker MC#</label>
                        <input type="text" id="brokerMc" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rate ($)</label>
                        <input type="number" step="0.01" id="rate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pickup City</label>
                        <input type="text" id="pickupCity" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pickup State</label>
                        <input type="text" id="pickupState" maxlength="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery City</label>
                        <input type="text" id="deliveryCity" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery State</label>
                        <input type="text" id="deliveryState" maxlength="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pickup Date</label>
                        <input type="date" id="pickupDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Date</label>
                        <input type="date" id="deliveryDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Miles</label>
                        <input type="number" id="miles" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="pending">Pending</option>
                            <option value="booked">Booked</option>
                            <option value="in_transit">In Transit</option>
                            <option value="delivered">Delivered</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Commodity</label>
                        <input type="text" id="commodity" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Load</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // AUTH STATE & SESSION MANAGEMENT
        // ============================================
        
        let currentUser = null;
        let accessToken = null;
        let refreshToken = null;

        // Check for existing session on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
        });

        function checkSession() {
            // Try to load session from localStorage
            const storedSession = localStorage.getItem('luxon_session');
            if (storedSession) {
                const session = JSON.parse(storedSession);
                accessToken = session.accessToken;
                refreshToken = session.refreshToken;
                
                // Verify session is still valid
                validateSession();
            }
        }

        async function validateSession() {
            try {
                const response = await fetch('/api/auth?action=session', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showApp();
                } else {
                    // Try to refresh the token
                    await refreshSession();
                }
            } catch (error) {
                console.error('Session validation error:', error);
                logout();
            }
        }

        async function refreshSession() {
            try {
                const response = await fetch('/api/auth?action=refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.session.accessToken;
                    refreshToken = data.session.refreshToken;
                    saveSession();
                    showApp();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function saveSession() {
            localStorage.setItem('luxon_session', JSON.stringify({
                accessToken,
                refreshToken
            }));
        }

        function logout() {
            currentUser = null;
            accessToken = null;
            refreshToken = null;
            localStorage.removeItem('luxon_session');
            showAuth();
        }

        // ============================================
        // AUTH UI HANDLERS
        // ============================================

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            hideAuthMessages();
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            hideAuthMessages();
        }

        function hideAuthMessages() {
            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authSuccess').classList.add('hidden');
        }

        function showAuthError(message) {
            const el = document.getElementById('authError');
            el.textContent = message;
            el.classList.remove('hidden');
            document.getElementById('authSuccess').classList.add('hidden');
        }

        function showAuthSuccess(message) {
            const el = document.getElementById('authSuccess');
            el.textContent = message;
            el.classList.remove('hidden');
            document.getElementById('authError').classList.add('hidden');
        }

        async function handleLogin(event) {
            event.preventDefault();
            hideAuthMessages();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div>';

            try {
                const response = await fetch('/api/auth?action=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUser = data.user;
                    accessToken = data.session.accessToken;
                    refreshToken = data.session.refreshToken;
                    saveSession();
                    showApp();
                } else {
                    showAuthError(data.error || 'Login failed');
                }
            } catch (error) {
                showAuthError('Network error. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Sign In</span>';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            hideAuthMessages();

            const fullName = document.getElementById('registerName').value;
            const companyName = document.getElementById('registerCompany').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const btn = document.getElementById('registerBtn');

            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div>';

            try {
                const response = await fetch('/api/auth?action=register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, fullName, companyName })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.requiresConfirmation) {
                        showAuthSuccess(data.message);
                        setTimeout(showLogin, 3000);
                    } else {
                        currentUser = data.user;
                        accessToken = data.session.accessToken;
                        refreshToken = data.session.refreshToken;
                        saveSession();
                        showApp();
                    }
                } else {
                    showAuthError(data.error || 'Registration failed');
                }
            } catch (error) {
                showAuthError('Network error. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Create Account</span>';
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth?action=logout', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
            } catch (e) {}
            logout();
        }

        // ============================================
        // APP UI
        // ============================================

        function showAuth() {
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            // Update user info in header
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.fullName || '';
                document.getElementById('userEmail').textContent = currentUser.email;
            }
            
            // Load user's loads
            loadLoads();
        }

        // ============================================
        // LOADS MANAGEMENT
        // ============================================

        async function loadLoads() {
            const search = document.getElementById('searchLoads').value;
            const status = document.getElementById('statusFilter').value;
            
            let url = '/api/loads?limit=50';
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (status) url += `&status=${encodeURIComponent(status)}`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.status === 401) {
                    await refreshSession();
                    return loadLoads();
                }

                const data = await response.json();
                renderLoads(data.loads || []);
                updateStats(data.loads || []);
            } catch (error) {
                console.error('Error loading loads:', error);
            }
        }

        function renderLoads(loads) {
            const tbody = document.getElementById('loadsTableBody');
            
            if (loads.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            No loads found. Upload a rate confirmation or add one manually.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = loads.map(load => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium">${load.load_number || '-'}</td>
                    <td class="px-6 py-4">${load.broker_name || '-'}</td>
                    <td class="px-6 py-4">
                        ${load.pickup_city || '?'}, ${load.pickup_state || '?'} â†’ 
                        ${load.delivery_city || '?'}, ${load.delivery_state || '?'}
                    </td>
                    <td class="px-6 py-4">${load.pickup_date || '-'}</td>
                    <td class="px-6 py-4">${load.delivery_date || '-'}</td>
                    <td class="px-6 py-4 font-semibold">$${load.rate?.toLocaleString() || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(load.status)}">
                            ${load.status || 'pending'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editLoad('${load.id}')" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                        <button onclick="deleteLoad('${load.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(status) {
            const colors = {
                pending: 'bg-yellow-100 text-yellow-800',
                booked: 'bg-blue-100 text-blue-800',
                in_transit: 'bg-purple-100 text-purple-800',
                delivered: 'bg-green-100 text-green-800',
                completed: 'bg-gray-100 text-gray-800'
            };
            return colors[status] || colors.pending;
        }

        function updateStats(loads) {
            document.getElementById('totalLoads').textContent = loads.length;
            document.getElementById('pendingLoads').textContent = loads.filter(l => l.status === 'pending').length;
            document.getElementById('completedLoads').textContent = loads.filter(l => l.status === 'completed' || l.status === 'delivered').length;
        }

        // ============================================
        // PDF UPLOAD
        // ============================================

        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('uploadStatus');
            statusEl.innerHTML = '<div class="loader mx-auto"></div><p class="mt-2 text-sm">Processing PDF with AI...</p>';

            try {
                // Convert PDF to base64
                const base64 = await fileToBase64(file);
                
                const response = await fetch('/api/parse-rateconf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        pdfBase64: base64,
                        fileName: file.name
                    })
                });

                if (response.status === 401) {
                    await refreshSession();
                    return handlePdfUpload(event);
                }

                const data = await response.json();

                if (data.success) {
                    statusEl.innerHTML = '<span class="text-green-600">âœ“ Load imported successfully!</span>';
                    loadLoads();
                    setTimeout(() => {
                        statusEl.innerHTML = '<span class="text-gray-500">Click or drag PDF here</span>';
                    }, 3000);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                statusEl.innerHTML = `<span class="text-red-600">Error: ${error.message}</span>`;
            }

            event.target.value = '';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
            });
        }

        // ============================================
        // LOAD MODAL (ADD/EDIT)
        // ============================================

        let currentLoads = [];

        function showAddLoadModal() {
            document.getElementById('modalTitle').textContent = 'Add New Load';
            document.getElementById('loadId').value = '';
            document.getElementById('loadModal').querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id !== 'loadId') el.value = '';
            });
            document.getElementById('status').value = 'pending';
            document.getElementById('loadModal').classList.remove('hidden');
        }

        async function editLoad(id) {
            try {
                const response = await fetch(`/api/loads?id=${id}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                const load = data.load;

                document.getElementById('modalTitle').textContent = 'Edit Load';
                document.getElementById('loadId').value = load.id;
                document.getElementById('loadNumber').value = load.load_number || '';
                document.getElementById('brokerName').value = load.broker_name || '';
                document.getElementById('brokerMc').value = load.broker_mc || '';
                document.getElementById('rate').value = load.rate || '';
                document.getElementById('pickupCity').value = load.pickup_city || '';
                document.getElementById('pickupState').value = load.pickup_state || '';
                document.getElementById('deliveryCity').value = load.delivery_city || '';
                document.getElementById('deliveryState').value = load.delivery_state || '';
                document.getElementById('pickupDate').value = load.pickup_date || '';
                document.getElementById('deliveryDate').value = load.delivery_date || '';
                document.getElementById('miles').value = load.miles || '';
                document.getElementById('status').value = load.status || 'pending';
                document.getElementById('commodity').value = load.commodity || '';
                document.getElementById('notes').value = load.notes || '';

                document.getElementById('loadModal').classList.remove('hidden');
            } catch (error) {
                alert('Error loading load details');
            }
        }

        function closeModal() {
            document.getElementById('loadModal').classList.add('hidden');
        }

        async function handleSaveLoad(event) {
            event.preventDefault();

            const id = document.getElementById('loadId').value;
            const loadData = {
                load_number: document.getElementById('loadNumber').value,
                broker_name: document.getElementById('brokerName').value,
                broker_mc: document.getElementById('brokerMc').value,
                rate: parseFloat(document.getElementById('rate').value) || null,
                pickup_city: document.getElementById('pickupCity').value,
                pickup_state: document.getElementById('pickupState').value,
                delivery_city: document.getElementById('deliveryCity').value,
                delivery_state: document.getElementById('deliveryState').value,
                pickup_date: document.getElementById('pickupDate').value,
                delivery_date: document.getElementById('deliveryDate').value,
                miles: parseInt(document.getElementById('miles').value) || null,
                status: document.getElementById('status').value,
                commodity: document.getElementById('commodity').value,
                notes: document.getElementById('notes').value
            };

            try {
                const url = id ? `/api/loads?id=${id}` : '/api/loads';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(loadData)
                });

                if (response.ok) {
                    closeModal();
                    loadLoads();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error saving load');
                }
            } catch (error) {
                alert('Error saving load');
            }
        }

        async function deleteLoad(id) {
            if (!confirm('Are you sure you want to delete this load?')) return;

            try {
                const response = await fetch(`/api/loads?id=${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    loadLoads();
                } else {
                    alert('Error deleting load');
                }
            } catch (error) {
                alert('Error deleting load');
            }
        }

        // ============================================
        // UTILITIES
        // ============================================

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
