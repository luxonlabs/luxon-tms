<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luxon TMS - AI-Powered Load Management</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-input: #1a1a24;
      --accent: #00d4aa;
      --accent-dim: #00a88a;
      --text: #e8e8ed;
      --text-dim: #8888a0;
      --border: #2a2a3a;
      --danger: #ff4757;
      --warning: #ffa502;
      --success: #00d4aa;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* LOGIN SCREEN */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    }
    
    .login-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 48px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    
    .login-box h1 {
      font-size: 28px;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent) 0%, #00ff88 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .login-box p {
      color: var(--text-dim);
      margin-bottom: 32px;
    }
    
    .login-box input {
      width: 100%;
      padding: 14px 18px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 16px;
      margin-bottom: 16px;
    }
    
    .login-box input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .login-box button {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .login-box button:hover {
      background: var(--accent-dim);
      transform: translateY(-1px);
    }
    
    .login-error {
      color: var(--danger);
      font-size: 14px;
      margin-top: 12px;
      display: none;
    }
    
    /* MAIN APP */
    #app { display: none; }
    
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, #00ff88 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .btn-primary {
      background: var(--accent);
      color: #000;
    }
    
    .btn-primary:hover {
      background: var(--accent-dim);
    }
    
    .btn-secondary {
      background: var(--bg-input);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      border-color: var(--accent);
    }
    
    .btn-ai {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-ai:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    /* MAIN CONTENT */
    .main-content {
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    /* STATS ROW */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
    }
    
    .stat-value.green { color: var(--success); }
    .stat-value.yellow { color: var(--warning); }
    
    /* LOADS TABLE */
    .table-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .table-header h2 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .search-input {
      padding: 8px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      width: 250px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      text-align: left;
      padding: 14px 16px;
      background: var(--bg-input);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    
    tr:hover {
      background: rgba(0, 212, 170, 0.05);
    }
    
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-pending { background: rgba(255, 165, 2, 0.2); color: var(--warning); }
    .status-dispatched { background: rgba(102, 126, 234, 0.2); color: #667eea; }
    .status-delivered { background: rgba(0, 212, 170, 0.2); color: var(--success); }
    .status-invoiced { background: rgba(118, 75, 162, 0.2); color: #a855f7; }
    
    .rpm-good { color: var(--success); font-weight: 600; }
    .rpm-ok { color: var(--warning); font-weight: 600; }
    .rpm-bad { color: var(--danger); font-weight: 600; }
    
    /* AI IMPORT MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h2 {
      font-size: 22px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .modal-subtitle {
      color: var(--text-dim);
      margin-bottom: 24px;
    }
    
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 48px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 24px;
    }
    
    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--accent);
      background: rgba(0, 212, 170, 0.05);
    }
    
    .drop-zone-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .drop-zone p {
      color: var(--text-dim);
    }
    
    .drop-zone .highlight {
      color: var(--accent);
      font-weight: 600;
    }
    
    #file-input { display: none; }
    
    .selected-file {
      background: var(--bg-input);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 12px;
    }
    
    .selected-file.active { display: flex; }
    
    .file-icon { font-size: 24px; }
    .file-name { flex: 1; font-weight: 500; }
    .file-remove {
      color: var(--danger);
      cursor: pointer;
      font-size: 18px;
    }
    
    .parsing-status {
      text-align: center;
      padding: 24px;
      display: none;
    }
    
    .parsing-status.active { display: block; }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .parsed-data {
      display: none;
    }
    
    .parsed-data.active { display: block; }
    
    .parsed-field {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .parsed-field:last-child { border-bottom: none; }
    
    .field-label {
      color: var(--text-dim);
      font-size: 13px;
    }
    
    .field-value {
      font-weight: 500;
    }
    
    .field-value.editable {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px 8px;
      color: var(--text);
      text-align: right;
      min-width: 150px;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .modal-actions .btn { flex: 1; }
    
    /* LOAD FORM MODAL */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group.full-width {
      grid-column: span 2;
    }
    
    .form-group label {
      font-size: 13px;
      color: var(--text-dim);
    }
    
    .form-group input, .form-group select {
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* TOAST */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 8px;
      font-weight: 500;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
    }
    
    .toast.active {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast.success { background: var(--success); color: #000; }
    .toast.error { background: var(--danger); color: #fff; }
    
    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text);
    }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-box">
    <h1>LUXON TMS</h1>
    <p>AI-Powered Load Management</p>
    <input type="password" id="password-input" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
    <button onclick="login()">Sign In</button>
    <p class="login-error" id="login-error">Invalid password</p>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <header class="header">
    <div class="logo">LUXON TMS</div>
    <div class="header-actions">
      <button class="btn btn-ai" onclick="openAIImport()">
        <span>ðŸ¤–</span> AI Import
      </button>
      <button class="btn btn-primary" onclick="openAddLoad()">+ Add Load</button>
      <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
  </header>

  <main class="main-content">
    <!-- STATS -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-label">Active Loads</div>
        <div class="stat-value" id="stat-active">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">This Week Revenue</div>
        <div class="stat-value green" id="stat-revenue">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg RPM</div>
        <div class="stat-value yellow" id="stat-rpm">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending Invoice</div>
        <div class="stat-value" id="stat-pending">$0</div>
      </div>
    </div>

    <!-- LOADS TABLE -->
    <div class="table-container">
      <div class="table-header">
        <h2>Loads</h2>
        <input type="text" class="search-input" placeholder="Search loads..." oninput="filterLoads(this.value)">
      </div>
      <table>
        <thead>
          <tr>
            <th>Load ID</th>
            <th>Broker</th>
            <th>Route</th>
            <th>Pickup</th>
            <th>Miles</th>
            <th>Rate</th>
            <th>RPM</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="loads-table">
          <!-- Loads will be inserted here -->
        </tbody>
      </table>
      <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-state-icon">ðŸ“¦</div>
        <h3>No loads yet</h3>
        <p>Click "AI Import" to parse a rate confirmation or "Add Load" to create one manually.</p>
      </div>
    </div>
  </main>
</div>

<!-- AI IMPORT MODAL -->
<div class="modal-overlay" id="ai-modal">
  <div class="modal">
    <h2>ðŸ¤– AI Import</h2>
    <p class="modal-subtitle">Upload a rate confirmation PDF and let AI extract the details</p>
    
    <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
      <div class="drop-zone-icon">ðŸ“„</div>
      <p>Drag & drop your PDF here or <span class="highlight">browse</span></p>
    </div>
    <input type="file" id="file-input" accept=".pdf" onchange="handleFileSelect(event)">
    
    <div class="selected-file" id="selected-file">
      <span class="file-icon">ðŸ“„</span>
      <span class="file-name" id="file-name"></span>
      <span class="file-remove" onclick="clearFile()">âœ•</span>
    </div>
    
    <div class="parsing-status" id="parsing-status">
      <div class="spinner"></div>
      <p>AI is reading your rate confirmation...</p>
    </div>
    
    <div class="parsed-data" id="parsed-data">
      <div class="parsed-field">
        <span class="field-label">Load ID</span>
        <input class="field-value editable" id="parsed-id">
      </div>
      <div class="parsed-field">
        <span class="field-label">Broker</span>
        <input class="field-value editable" id="parsed-broker">
      </div>
      <div class="parsed-field">
        <span class="field-label">Origin</span>
        <input class="field-value editable" id="parsed-origin">
      </div>
      <div class="parsed-field">
        <span class="field-label">Destination</span>
        <input class="field-value editable" id="parsed-destination">
      </div>
      <div class="parsed-field">
        <span class="field-label">Pickup Date</span>
        <input class="field-value editable" id="parsed-pickup" type="text">
      </div>
      <div class="parsed-field">
        <span class="field-label">Delivery Date</span>
        <input class="field-value editable" id="parsed-delivery" type="text">
      </div>
      <div class="parsed-field">
        <span class="field-label">Miles</span>
        <input class="field-value editable" id="parsed-miles" type="number">
      </div>
      <div class="parsed-field">
        <span class="field-label">Rate</span>
        <input class="field-value editable" id="parsed-rate" type="number">
      </div>
      <div class="parsed-field">
        <span class="field-label">Equipment</span>
        <input class="field-value editable" id="parsed-equipment">
      </div>
      <div class="parsed-field">
        <span class="field-label">Contact</span>
        <input class="field-value editable" id="parsed-contact">
      </div>
      <div class="parsed-field">
        <span class="field-label">Phone</span>
        <input class="field-value editable" id="parsed-phone">
      </div>
      <div class="parsed-field">
        <span class="field-label">Email</span>
        <input class="field-value editable" id="parsed-email">
      </div>
      <div class="parsed-field">
        <span class="field-label">Shipper</span>
        <input class="field-value editable" id="parsed-shipper">
      </div>
      <div class="parsed-field">
        <span class="field-label">Receiver</span>
        <input class="field-value editable" id="parsed-receiver">
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeAIImport()">Cancel</button>
      <button class="btn btn-primary" id="parse-btn" onclick="parsePDF()">Parse PDF</button>
      <button class="btn btn-primary" id="save-parsed-btn" onclick="saveParsedLoad()" style="display: none;">Save Load</button>
    </div>
  </div>
</div>

<!-- ADD LOAD MODAL -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <h2>Add New Load</h2>
    <p class="modal-subtitle">Enter load details manually</p>
    
    <div class="form-grid">
      <div class="form-group">
        <label>Load ID *</label>
        <input type="text" id="form-id" required>
      </div>
      <div class="form-group">
        <label>Broker Company</label>
        <input type="text" id="form-broker">
      </div>
      <div class="form-group">
        <label>Origin</label>
        <input type="text" id="form-origin" placeholder="City ST">
      </div>
      <div class="form-group">
        <label>Destination</label>
        <input type="text" id="form-destination" placeholder="City ST">
      </div>
      <div class="form-group">
        <label>Pickup Date</label>
        <input type="date" id="form-pickup">
      </div>
      <div class="form-group">
        <label>Delivery Date</label>
        <input type="date" id="form-delivery">
      </div>
      <div class="form-group">
        <label>Miles</label>
        <input type="number" id="form-miles">
      </div>
      <div class="form-group">
        <label>Rate ($)</label>
        <input type="number" id="form-rate">
      </div>
      <div class="form-group">
        <label>Equipment</label>
        <select id="form-equipment">
          <option value="R">Reefer</option>
          <option value="V">Van</option>
          <option value="F">Flatbed</option>
          <option value="VR">Van/Reefer</option>
        </select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="form-status">
          <option value="pending">Pending</option>
          <option value="dispatched">Dispatched</option>
          <option value="delivered">Delivered</option>
          <option value="invoiced">Invoiced</option>
        </select>
      </div>
      <div class="form-group">
        <label>Contact</label>
        <input type="text" id="form-contact">
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input type="text" id="form-phone">
      </div>
      <div class="form-group">
        <label>Shipper</label>
        <input type="text" id="form-shipper">
      </div>
      <div class="form-group">
        <label>Receiver</label>
        <input type="text" id="form-receiver">
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeAddLoad()">Cancel</button>
      <button class="btn btn-primary" onclick="saveManualLoad()">Save Load</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ========== CONFIG ==========
const SUPABASE_URL = 'https://saqppcruujjeouqqvrgr.supabase.co';  // Replace with your Supabase URL
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhcXBwY3J1dWpqZW91cXF2cmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDI0NTcsImV4cCI6MjA3NDk3ODQ1N30.0jxb44Sn7VNqaEeI_i8kheufXLAtAk_sWrYaJJDiMd0';  // Replace with your Supabase anon key
const API_URL = '/api/parse-rateconf';  // Vercel serverless function

let db = null;
let currentPassword = '';
let allLoads = [];
let selectedFile = null;
let parsedLoadData = null;

// ========== INIT ==========
function init() {
  // Check for saved session
  const saved = localStorage.getItem('tms_session');
  if (saved) {
    currentPassword = saved;
    showApp();
  }
}

// ========== AUTH ==========
async function login() {
  const pwd = document.getElementById('password-input').value;
  
  // For now, just store password and use it for API calls
  // The API will validate the password
  currentPassword = pwd;
  localStorage.setItem('tms_session', pwd);
  
  // Initialize Supabase
  if (SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
    db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }
  
  showApp();
}

function logout() {
  localStorage.removeItem('tms_session');
  currentPassword = '';
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('password-input').value = '';
}

async function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  
  if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && !db) {
    db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }
  
  await loadLoads();
}

// ========== LOADS ==========
async function loadLoads() {
  if (!db) {
    // Demo mode - use localStorage
    allLoads = JSON.parse(localStorage.getItem('tms_loads') || '[]');
  } else {
    const { data, error } = await db.from('loads').select('*').order('created_at', { ascending: false });
    if (error) {
      console.error('Error loading loads:', error);
      showToast('Error loading loads', 'error');
      return;
    }
    allLoads = data || [];
  }
  
  renderLoads();
  updateStats();
}

function renderLoads(loads = allLoads) {
  const tbody = document.getElementById('loads-table');
  const emptyState = document.getElementById('empty-state');
  
  if (loads.length === 0) {
    tbody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  tbody.innerHTML = loads.map(load => {
    const rpm = load.miles > 0 ? (load.booked_rate / load.miles).toFixed(2) : '0.00';
    const rpmClass = rpm >= 3.5 ? 'rpm-good' : rpm >= 2.5 ? 'rpm-ok' : 'rpm-bad';
    
    return `
      <tr>
        <td><strong>${load.id || '-'}</strong></td>
        <td>${load.broker_company || '-'}</td>
        <td>${load.origin || '-'} â†’ ${load.destination || '-'}</td>
        <td>${load.pickup_date || '-'}</td>
        <td>${load.miles || '-'}</td>
        <td>$${(load.booked_rate || 0).toLocaleString()}</td>
        <td class="${rpmClass}">$${rpm}</td>
        <td><span class="status-badge status-${load.status || 'pending'}">${load.status || 'pending'}</span></td>
        <td>
          <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="deleteLoad('${load.id}')">Delete</button>
        </td>
      </tr>
    `;
  }).join('');
}

function filterLoads(query) {
  if (!query) {
    renderLoads();
    return;
  }
  
  const filtered = allLoads.filter(load => 
    (load.load_id || '').toLowerCase().includes(query.toLowerCase()) ||
    (load.broker_company || '').toLowerCase().includes(query.toLowerCase()) ||
    (load.origin || '').toLowerCase().includes(query.toLowerCase()) ||
    (load.destination || '').toLowerCase().includes(query.toLowerCase())
  );
  
  renderLoads(filtered);
}

function updateStats() {
  const active = allLoads.filter(l => l.status !== 'invoiced').length;
  const revenue = allLoads.reduce((sum, l) => sum + (l.booked_rate || 0), 0);
  const totalMiles = allLoads.reduce((sum, l) => sum + (l.miles || 0), 0);
  const avgRpm = totalMiles > 0 ? (revenue / totalMiles).toFixed(2) : '0.00';
  const pending = allLoads.filter(l => l.status === 'delivered').reduce((sum, l) => sum + (l.booked_rate || 0), 0);
  
  document.getElementById('stat-active').textContent = active;
  document.getElementById('stat-revenue').textContent = '$' + revenue.toLocaleString();
  document.getElementById('stat-rpm').textContent = '$' + avgRpm;
  document.getElementById('stat-pending').textContent = '$' + pending.toLocaleString();
}

async function saveLoad(loadData) {
  if (!db) {
    // Demo mode - use localStorage
    loadData.updated_at = new Date().toISOString();
    // Check if exists
    const existingIndex = allLoads.findIndex(l => l.id === loadData.id);
    if (existingIndex >= 0) {
      allLoads[existingIndex] = loadData;
    } else {
      allLoads.unshift(loadData);
    }
    localStorage.setItem('tms_loads', JSON.stringify(allLoads));
  } else {
    // Upsert - insert or update if id exists
    const { data, error } = await db.from('loads').upsert([loadData], { onConflict: 'id' }).select();
    if (error) {
      console.error('Error saving load:', error);
      showToast('Error saving load: ' + error.message, 'error');
      return false;
    }
    // Reload to get fresh data
    await loadLoads();
    return true;
  }
  
  renderLoads();
  updateStats();
  return true;
}

async function deleteLoad(id) {
  if (!confirm('Delete this load?')) return;
  
  if (!db) {
    allLoads = allLoads.filter(l => l.id !== id);
    localStorage.setItem('tms_loads', JSON.stringify(allLoads));
  } else {
    const { error } = await db.from('loads').delete().eq('id', id);
    if (error) {
      showToast('Error deleting load', 'error');
      return;
    }
    allLoads = allLoads.filter(l => l.id !== id);
  }
  
  renderLoads();
  updateStats();
  showToast('Load deleted', 'success');
}

// ========== AI IMPORT ==========
function openAIImport() {
  document.getElementById('ai-modal').classList.add('active');
  resetAIModal();
}

function closeAIImport() {
  document.getElementById('ai-modal').classList.remove('active');
  resetAIModal();
}

function resetAIModal() {
  selectedFile = null;
  parsedLoadData = null;
  document.getElementById('file-input').value = '';
  document.getElementById('selected-file').classList.remove('active');
  document.getElementById('parsing-status').classList.remove('active');
  document.getElementById('parsed-data').classList.remove('active');
  document.getElementById('drop-zone').style.display = 'block';
  document.getElementById('parse-btn').style.display = 'block';
  document.getElementById('save-parsed-btn').style.display = 'none';
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (file && file.type === 'application/pdf') {
    selectedFile = file;
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('selected-file').classList.add('active');
  }
}

function clearFile() {
  selectedFile = null;
  document.getElementById('file-input').value = '';
  document.getElementById('selected-file').classList.remove('active');
}

// Drag and drop
const dropZone = document.getElementById('drop-zone');

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  
  const file = e.dataTransfer.files[0];
  if (file && file.type === 'application/pdf') {
    selectedFile = file;
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('selected-file').classList.add('active');
  }
});

async function parsePDF() {
  if (!selectedFile) {
    showToast('Please select a PDF file', 'error');
    return;
  }
  
  // Show loading
  document.getElementById('drop-zone').style.display = 'none';
  document.getElementById('selected-file').classList.remove('active');
  document.getElementById('parsing-status').classList.add('active');
  document.getElementById('parse-btn').style.display = 'none';
  
  try {
    // Convert PDF to base64
    const base64 = await fileToBase64(selectedFile);
    
    // Call API
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        pdfBase64: base64,
        password: currentPassword
      })
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.error || 'Failed to parse PDF');
    }
    
    parsedLoadData = result.data;
    
    // Populate fields
    document.getElementById('parsed-id').value = parsedLoadData.id || '';
    document.getElementById('parsed-broker').value = parsedLoadData.broker_company || '';
    document.getElementById('parsed-origin').value = parsedLoadData.origin || '';
    document.getElementById('parsed-destination').value = parsedLoadData.destination || '';
    document.getElementById('parsed-pickup').value = parsedLoadData.pickup_date || '';
    document.getElementById('parsed-delivery').value = parsedLoadData.delivery_date || '';
    document.getElementById('parsed-miles').value = parsedLoadData.miles || '';
    document.getElementById('parsed-rate').value = parsedLoadData.booked_rate || '';
    document.getElementById('parsed-equipment').value = parsedLoadData.equipment || '';
    document.getElementById('parsed-contact').value = parsedLoadData.contact || '';
    document.getElementById('parsed-phone').value = parsedLoadData.phone || '';
    document.getElementById('parsed-email').value = parsedLoadData.email || '';
    document.getElementById('parsed-shipper').value = parsedLoadData.shipper || '';
    document.getElementById('parsed-receiver').value = parsedLoadData.receiver || '';
    
    // Show parsed data
    document.getElementById('parsing-status').classList.remove('active');
    document.getElementById('parsed-data').classList.add('active');
    document.getElementById('save-parsed-btn').style.display = 'block';
    
    showToast('PDF parsed successfully!', 'success');
    
  } catch (error) {
    console.error('Parse error:', error);
    document.getElementById('parsing-status').classList.remove('active');
    document.getElementById('drop-zone').style.display = 'block';
    document.getElementById('parse-btn').style.display = 'block';
    showToast(error.message || 'Failed to parse PDF', 'error');
  }
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function saveParsedLoad() {
  // Get values from editable fields
  const loadData = {
    id: document.getElementById('parsed-id').value,
    broker_company: document.getElementById('parsed-broker').value,
    origin: document.getElementById('parsed-origin').value,
    destination: document.getElementById('parsed-destination').value,
    pickup_date: document.getElementById('parsed-pickup').value,
    delivery_date: document.getElementById('parsed-delivery').value,
    miles: parseInt(document.getElementById('parsed-miles').value) || 0,
    booked_rate: parseFloat(document.getElementById('parsed-rate').value) || 0,
    posted_rate: 0,
    equipment: document.getElementById('parsed-equipment').value,
    contact: document.getElementById('parsed-contact').value,
    phone: document.getElementById('parsed-phone').value,
    email: document.getElementById('parsed-email').value,
    shipper: document.getElementById('parsed-shipper').value,
    receiver: document.getElementById('parsed-receiver').value,
    status: 'pending'
  };
  
  if (!loadData.id) {
    showToast('Load ID is required', 'error');
    return;
  }
  
  const success = await saveLoad(loadData);
  if (success) {
    closeAIImport();
    showToast('Load saved successfully!', 'success');
  }
}

// ========== MANUAL ADD ==========
function openAddLoad() {
  document.getElementById('add-modal').classList.add('active');
}

function closeAddLoad() {
  document.getElementById('add-modal').classList.remove('active');
  // Clear form
  document.querySelectorAll('#add-modal input').forEach(i => i.value = '');
}

async function saveManualLoad() {
  const loadId = document.getElementById('form-id').value;
  if (!loadId) {
    showToast('Load ID is required', 'error');
    return;
  }
  
  const loadData = {
    id: loadId,
    broker_company: document.getElementById('form-broker').value,
    origin: document.getElementById('form-origin').value,
    destination: document.getElementById('form-destination').value,
    pickup_date: document.getElementById('form-pickup').value,
    delivery_date: document.getElementById('form-delivery').value,
    miles: parseInt(document.getElementById('form-miles').value) || 0,
    booked_rate: parseFloat(document.getElementById('form-rate').value) || 0,
    posted_rate: 0,
    equipment: document.getElementById('form-equipment').value,
    status: document.getElementById('form-status').value,
    contact: document.getElementById('form-contact').value,
    phone: document.getElementById('form-phone').value,
    shipper: document.getElementById('form-shipper').value,
    receiver: document.getElementById('form-receiver').value
  };
  
  const success = await saveLoad(loadData);
  if (success) {
    closeAddLoad();
    showToast('Load saved successfully!', 'success');
  }
}

// ========== TOAST ==========
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} active`;
  setTimeout(() => toast.classList.remove('active'), 3000);
}

// Init on load
init();
</script>

</body>
</html>
